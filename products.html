  <!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•†å“ / ä½œå“</title>

  <style>
    :root{
      --bg:#ffffff;
      --border:#e5e7eb;
      --muted:#6b7280;
      --soft:#f7f9fc;
      --accent:#0b69ff;
      --danger:#d11;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Helvetica Neue",Arial,"Noto Sans TC",sans-serif;
      color:#111;
      background:var(--bg);
    }
    a{color:inherit;text-decoration:none}

    .wrap{
      max-width:1600px;
      margin:24px auto;
      padding:18px;
    }

    .top{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .top a{font-weight:800}

    .banner{
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      background:var(--soft);
      margin-bottom:14px;
    }
    .banner h3{ margin:0 0 8px; font-size:18px; }
    .banner .content{
      white-space:pre-wrap;
      line-height:1.7;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin:14px 0;
    }
    .search{
      flex:1;
      min-width:260px;
      padding:12px 14px;
      border:1px solid #dbe2ea;
      border-radius:14px;
      outline:none;
      font-size:16px;
    }
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      min-height:40px; /* âœ… é¿å…ç©ºç™½çœ‹èµ·ä¾†åƒæ¶ˆå¤± */
    }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color:#bcd4ff;
      background:#f1f6ff;
      color:#0b69ff;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:14px;
    }
    @media (max-width: 1400px){ .grid{grid-template-columns: repeat(4, 1fr);} }
    @media (max-width: 1100px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 820px){  .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){  .grid{grid-template-columns: 1fr;} }

    .card{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .thumb{
      width:100%;
      aspect-ratio: 16/10;
      background:#f3f6fb;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pad{ padding:14px; }
    .name{ font-size:18px; font-weight:900; margin:0 0 4px; }
    .sku{ color:var(--muted); font-weight:800; margin-bottom:10px; }

    .badges{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px; }
    .badge{
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-weight:900;
      background:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge.ok{ border-color:#cfe2ff; color:#0b69ff; background:#f1f6ff; }
    .badge.soldout{ border-color:#fecaca; color:#b91c1c; background:#fff5f5; }
    .badge.preorder{ border-color:#fde68a; color:#92400e; background:#fffbeb; }

    .priceRow{
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
      margin:10px 0 8px;
    }
    .priceNow{
      font-weight:1000;
      font-size:20px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #cfe2ff;
      background:#f1f6ff;
      color:#0b69ff;
      white-space:nowrap;
    }
    .priceOld{
      font-weight:900;
      font-size:14px;
      color:#9ca3af;
      text-decoration:line-through;
      white-space:nowrap;
    }
    .priceSpecial{
      font-weight:900;
      font-size:16px;          /* âœ… è·ŸåŸæœ¬ priceNow ä¸€æ¨£å¤§å° */
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #fecaca;
      background:#fff5f5;
      color:#d11;              /* ç´…è‰²ä¿ç•™ */
      display:inline-flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }


    .meta{ color:var(--muted); font-size:14px; line-height:1.6; margin-top:8px; }
    .meta .line{ margin-top:4px; }

    .btn{
      margin-top:12px;
      display:inline-block;
      padding:10px 12px;
      border-radius:12px;
      background:var(--accent);
      color:#fff;
      font-weight:1000;
    }
    .btn.gray{ background:#d1d5db; color:#111; cursor:not-allowed; }

    .foot{ margin-top:14px; color:var(--muted); font-size:14px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <a href="/index.html">â† å›é¦–é </a>
      <a href="/cart.html">å‰å¾€è³¼ç‰©è»Š â†’</a>
    </div>

    <div class="banner" id="banner" style="display:none;">
      <h3 id="bannerTitle">å…¬å‘Š</h3>
      <div class="content" id="bannerContent"></div>
    </div>

    <div class="controls">
      <input id="q" class="search" placeholder="æœå°‹ï¼šåç¨± / ç·¨è™Ÿ / é—œéµå­—â€¦" />
      <div class="chips" id="chips"></div>
    </div>

    <div class="grid" id="grid"></div>
    <div class="foot" id="count"></div>
  </div>

<script>
const SHEET_ID="1CFUndaTaa_idLh82JxHp6AXCWPTAUFM8AzGW9NIryIA";
const SHEET_PRODUCTS="Products";
const SHEET_CATEGORIES="Categories";
const SHEET_PUBLIC="Public";

function gvizUrl(name){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(name)}&tqx=out:json`;
}
async function fetchSheet(name){
  const r = await fetch(gvizUrl(name), { cache:"no-store" });
  const t = await r.text();
  const j = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}")+1));
  const cols = j.table.cols.map(c=>c.label);
  return j.table.rows.map(row=>{
    const o = {};
    row.c.forEach((cell,i)=> o[cols[i]] = cell ? cell.v : "");
    return o;
  });
}
function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;");
}
function isEnabled(v){
  return v === true || String(v).toUpperCase().trim() === "TRUE";
}
function normStatus(v){
  return String(v || "").trim() || "in_stock";
}
function statusLabel(s){
  if(s==="sold_out") return "å”®å®Œ";
  if(s==="preorder") return "é è³¼";
  return "å¯è³¼è²·";
}
function statusClass(s){
  if(s==="sold_out") return "soldout";
  if(s==="preorder") return "preorder";
  return "ok";
}
function money(n){
  return `NT$ ${Number(n||0)}`;
}
function normalizeText(s){ return String(s || "").toLowerCase(); }

/* âœ… è®€æ¬„ä½ï¼šæ”¯æ´ä½ æŠŠ price_override æ”¹å«ã€Œç‰¹åƒ¹ã€ */
function pick(obj, keys){
  for(const k of keys){
    if(Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
  }
  return "";
}

/* options é¡¯ç¤ºç”¨ï¼ˆä½ è¦çš„ã€Œã€ã€åˆ†éš”ï¼‰ */
function parseOptionsPreview(str){
  if(!str) return "";
  const groups = String(str).split(";").map(x=>x.trim()).filter(Boolean);
  const lines = [];
  for(const g of groups){
    const [nRaw, restRaw] = g.split(":");
    const name = (nRaw||"").trim();
    const rest = (restRaw||"").trim();
    if(!name || !rest) continue;

    const items = rest.split("|").map(x=>x.trim()).filter(Boolean).map(item=>{
      const [valRaw, deltaRaw] = item.split("=");
      const val = (valRaw||"").trim();
      const delta = Number((deltaRaw||"0").trim() || 0);
      if(!val) return null;
      return delta ? `${val}ï¼ˆ+${delta}ï¼‰` : val;
    }).filter(Boolean);

    if(items.length){
      lines.push(`${name}ï¼š${items.join("ã€")}`);
    }
  }
  return lines.join("\n");
}

let PRODUCTS=[];
let CATS=[];
let ACTIVE_CAT="å…¨éƒ¨";

function renderChips(){
  const chips = document.getElementById("chips");
  const names = ["å…¨éƒ¨", ...CATS.map(c=>c.name).filter(Boolean)];
  chips.innerHTML = "";
  for(const n of names){
    const el = document.createElement("div");
    el.className = "chip" + (n===ACTIVE_CAT ? " active" : "");
    el.textContent = n;
    el.addEventListener("click", ()=>{
      ACTIVE_CAT = n;
      renderChips();
      renderGrid();
    });
    chips.appendChild(el);
  }
}

function matchCat(p){
  if(ACTIVE_CAT==="å…¨éƒ¨") return true;
  const cat = String(pick(p, ["category_path","åˆ†é¡","category"]) || "");
  return cat === ACTIVE_CAT;
}
function matchQuery(p, q){
  if(!q) return true;
  const hay = [
    pick(p, ["name","å•†å“åç¨±"]),
    pick(p, ["sku","å•†å“ç·¨è™Ÿ"]),
    pick(p, ["search_keyword","é—œéµå­—"]),
    pick(p, ["category_path","åˆ†é¡","category"]),
    pick(p, ["note","å‚™è¨»"]),
  ].map(normalizeText).join(" ");
  return hay.includes(q);
}

function computeDisplayPrice(p){
  const baseOriginal = Number(pick(p, ["price","åƒ¹æ ¼","åŸºç¤åƒ¹"]) || 0);

  /* âœ… ç‰¹åƒ¹æ¬„ä½ï¼šprice_override æˆ– ç‰¹åƒ¹ éƒ½åƒ */
  const overrideRaw = pick(p, ["price_override","ç‰¹åƒ¹"]);
  const baseSpecial = Number(overrideRaw || 0);
  const hasSpecial = String(overrideRaw).trim() !== "" && !Number.isNaN(baseSpecial) && baseSpecial > 0;

  return { baseOriginal, baseSpecial, hasSpecial, base: hasSpecial ? baseSpecial : baseOriginal };
}

function renderGrid(){
  const grid = document.getElementById("grid");
  const q = normalizeText(document.getElementById("q").value);

  const filtered = PRODUCTS
    .filter(p => isEnabled(pick(p, ["enabled","ä¸Šæ¶é–‹é—œ"])))
    .filter(p => normStatus(pick(p, ["status","ç‹€æ…‹"])) !== "hidden")
    .filter(p => matchCat(p))
    .filter(p => matchQuery(p, q))
    .sort((a,b)=> Number(pick(a,["sort","æ’åº"])||0) - Number(pick(b,["sort","æ’åº"])||0));

  grid.innerHTML = "";

  for(const p of filtered){
    const st = normStatus(pick(p, ["status","ç‹€æ…‹"]));
    const sold = st==="sold_out";
    const { baseOriginal, baseSpecial, hasSpecial, base } = computeDisplayPrice(p);

    const optPreview = parseOptionsPreview(pick(p, ["options","é¸é …"]) || "");
    const specVal = pick(p, ["spec","è¦æ ¼"]);
    const optLines = optPreview ? optPreview.split("\n").map(x=>escapeHtml(x)).join("<br>") : "";

    const priceHtml = hasSpecial
      ? `<div class="priceRow">
           <span class="priceOld">${money(baseOriginal)}</span>
           <span class="priceSpecial">ğŸ”¥ ç‰¹åƒ¹ ${money(baseSpecial)}</span>
         </div>`
      : `<div class="priceRow">
           <span class="priceNow">${money(base)}</span>
         </div>`;

    const btn = sold
      ? `<span class="btn gray">å·²å”®å®Œ</span>`
      : `<a class="btn" href="/product.html?sku=${encodeURIComponent(pick(p,["sku","å•†å“ç·¨è™Ÿ"]))}">æŸ¥çœ‹ / é¸é …</a>`;

    const img = pick(p, ["image_url","image","åœ–ç‰‡ç¶²å€","åœ–æª”ç¶²å€"]);
    const name = pick(p, ["name","å•†å“åç¨±"]);
    const sku  = pick(p, ["sku","å•†å“ç·¨è™Ÿ"]);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="thumb">
        ${img ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(name)}">` : "ç„¡åœ–ç‰‡"}
      </div>
      <div class="pad">
        <div class="name">${escapeHtml(name)}</div>
        <div class="sku">ç·¨è™Ÿï¼š${escapeHtml(sku)}</div>

        <div class="badges">
          <span class="badge ${statusClass(st)}">${statusLabel(st)}</span>
        </div>

        ${priceHtml}

        <div class="meta">
          ${specVal ? `<div class="line">è¦æ ¼ï¼š${escapeHtml(specVal)}</div>` : ""}
          ${optLines ? `<div class="line">${optLines}</div>` : ""}
        </div>

        ${btn}
      </div>
    `;
    grid.appendChild(card);
  }

  document.getElementById("count").textContent = `é¡¯ç¤º ${filtered.length} ç­†`;
}

async function renderBanner(){
  const rows = await fetchSheet(SHEET_PUBLIC);
  const active = rows
    .filter(r => isEnabled(pick(r, ["enabled","ä¸Šæ¶é–‹é—œ"])))
    .sort((a,b)=> Number(pick(a,["sort","æ’åº"])||0) - Number(pick(b,["sort","æ’åº"])||0));

  const bannerRow = active.find(r => String(pick(r,["key","éµ","ä»£è™Ÿ"])||"").trim() === "products_banner");
  if(!bannerRow) return;

  document.getElementById("banner").style.display = "block";
  document.getElementById("bannerTitle").textContent = pick(bannerRow,["title","æ¨™é¡Œ"]) || "å…¬å‘Š";
  document.getElementById("bannerContent").textContent = pick(bannerRow,["content","å…§å®¹"]) || "";
}

async function buildCategories(products){
  // 1) å…ˆè©¦ Categories sheet
  try{
    const cats = await fetchSheet(SHEET_CATEGORIES);
    const list = (cats||[])
      .filter(r => isEnabled(pick(r, ["enabled","ä¸Šæ¶é–‹é—œ"])))
      .sort((a,b)=> Number(pick(a,["sort","æ’åº"])||0) - Number(pick(b,["sort","æ’åº"])||0))
      .map(r => ({ name: String(pick(r, ["name","åˆ†é¡","category"])||"").trim() }))
      .filter(x => x.name);

    if(list.length) return list;
  }catch(e){
    // ignoreï¼Œæ”¹ç”¨ fallback
  }

  // 2) fallbackï¼šå¾ Products è‡ªå‹•ç”Ÿæˆ
  const uniq = Array.from(new Set(
    (products||[])
      .filter(p => isEnabled(pick(p, ["enabled","ä¸Šæ¶é–‹é—œ"])))
      .map(p => String(pick(p, ["category_path","åˆ†é¡","category"])||"").trim())
      .filter(Boolean)
  ));
  return uniq.map(name=>({name}));
}

(async function init(){
  const [products] = await Promise.all([ fetchSheet(SHEET_PRODUCTS) ]);
  PRODUCTS = products || [];

  CATS = await buildCategories(PRODUCTS);

  renderChips();
  renderGrid();
  renderBanner();

  document.getElementById("q").addEventListener("input", renderGrid);
})();
</script>
</body>
</html>
