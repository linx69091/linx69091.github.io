<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å•†å“ / ä½œå“</title>

  <!-- Markdown è§£æï¼ˆæ”¯æ´æ›è¡Œã€é …ç›®ç¬¦è™Ÿã€emojiï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --line:#e6e9ef;
      --text:#111827;
      --muted:#6b7280;
      --primary:#1667ff;
      --primary-weak:#e9f0ff;
      --danger:#dc2626;
      --danger-weak:#ffe8e8;
      --shadow: 0 6px 18px rgba(17,24,39,.06);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC","Noto Sans TC","Microsoft JhengHei", Arial;
      color:var(--text);
      background:var(--bg);
    }
    a{color:inherit;text-decoration:none}

    .page{
      max-width:1280px;
      margin:0 auto;
      padding:18px 18px 48px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .topbar a{
      font-weight:600;
      color:var(--muted);
    }

    .banner{
      background:#f3f4f6;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px 18px;
      margin-bottom:14px;
      overflow:hidden;
    }
    .banner h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .banner .content{
      color:#111827;
      font-size:14px;
      line-height:1.7;
    }
    .banner .content :is(p,ul,ol){margin:0 0 10px}
    .banner .content ul{padding-left:1.2em}
    .banner .content li{margin:.2em 0}
    /* è®“ Markdown çš„æ›è¡Œæ›´åƒä½ åœ¨ sheet è£¡æ‰“çš„æ¨£å­ */
    .banner .content p{white-space:normal}

    /* æœå°‹åœ¨ä¸Šã€åˆ†é¡åœ¨ä¸‹ï¼ˆä½ æŒ‡å®šçš„ï¼‰ */
    .controls{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin:12px 0 14px;
    }
    .search{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search input{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:12px 14px;
      font-size:14px;
      outline:none;
    }
    .search input:focus{
      border-color:#c7d2fe;
      box-shadow:0 0 0 4px rgba(99,102,241,.12);
    }

    .cats{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      overflow:auto;
      padding-bottom:2px;
    }
    .chip{
      flex:0 0 auto;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-size:14px;
      font-weight:700;
      color:#111827;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color:#9bbcff;
      background:var(--primary-weak);
      color:#0b49d7;
    }

    .meta{
      margin:10px 0 6px;
      color:var(--muted);
      font-size:13px;
    }

    /* âœ… é—œéµï¼šå¡ç‰‡ä¸å› åˆ†é¡/é‡æ’è€Œæ’çˆ† */
    .grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1180px){
      .grid{grid-template-columns:repeat(3, minmax(0, 1fr));}
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:repeat(2, minmax(0, 1fr));}
    }
    @media (max-width: 540px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 520px; /* ç©©ä½é«˜åº¦ï¼Œé¿å…ç¯©é¸å¾Œè·³å‹• */
    }

    /* å›ºå®šåœ–ç‰‡å€æ¯”ä¾‹ï¼Œé¿å…ã€Œåˆ†é¡é çˆ†åœ–ã€ */
    .thumb{
      width:100%;
      aspect-ratio: 16 / 10;
      background:#f8fafc;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      border-bottom:1px solid var(--line);
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      transform: translateZ(0);
    }

    .body{
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }

    .name{
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
      margin:0;
      line-height:1.2;
    }
    .sku{
      margin:0;
      color:var(--muted);
      font-size:14px;
      font-weight:600;
    }

    .row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-weight:800;
      font-size:14px;
      line-height:1;
      background:#fff;
    }

    /* ä½ èªªã€Œå¯è³¼è²·ã€å¤ªå¤§ â†’ ç¸®å›å» */
    .badge.status{
      font-size:12px;
      padding:6px 9px;
      background:#f3f7ff;
      border-color:#cfe0ff;
      color:#0b49d7;
      font-weight:900;
    }
    .badge.sold{
      background:#fff1f2;
      border-color:#fecdd3;
      color:#be123c;
    }
    .badge.pre{
      background:#fff7ed;
      border-color:#fed7aa;
      color:#b45309;
    }

    /* åƒ¹æ ¼ï¼šåŸºç¤åƒ¹ä¸è¦å¤ªå¤§ */
    .badge.price{
      font-size:14px;          /* âœ… æ”¹å°ï¼ˆä½ é»åï¼‰ */
      padding:8px 12px;
      border-color:#b9d0ff;
      background:#f3f7ff;
      color:#0b49d7;
    }

    /* ç‰¹åƒ¹è¦–è¦ºï¼šå­—ä¸è¦æ¯”åŸºç¤åƒ¹å¤§ */
    .badge.special{
      font-size:14px;          /* âœ… èˆ‡ price åŒç´šï¼Œä¸è¦æ›´å¤§ */
      padding:8px 12px;
      border-color:#ffb4b4;
      background:var(--danger-weak);
      color:var(--danger);
      font-weight:900;
    }

    .oldprice{
      color:#9ca3af;
      font-weight:900;
      font-size:14px;          /* ä¸è¦æ¯”ç‰¹åƒ¹æ¶æˆ² */
      text-decoration:line-through;
      margin-right:6px;
    }

    .details{
      margin-top:2px;
      color:#374151;
      font-size:14px;
      line-height:1.6;
    }
    .details .line{
      display:block; /* âœ… options æ›è¡Œ */
      margin:2px 0;
      color:#374151;
      font-weight:700;
    }
    .details .line span{
      font-weight:600;
      color:#111827;
    }

    .cta{
      margin-top:auto;
      padding-top:8px;
    }
    .btn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-size:16px;
      font-weight:900;
      color:#fff;
      background:var(--primary);
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn.disabled{
      background:#d1d5db;
      cursor:not-allowed;
      color:#111827;
    }

    .empty{
      padding:18px;
      border:1px dashed var(--line);
      border-radius:var(--radius);
      color:var(--muted);
      background:#fff;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a href="./index.html">â† å›é¦–é </a>
      <a href="./cart.html">å‰å¾€è³¼ç‰©è»Š â†’</a>
    </div>

    <div class="banner" id="banner" style="display:none;">
      <h2 id="bannerTitle">å…¬å‘Š</h2>
      <div class="content" id="bannerContent"></div>
    </div>

    <div class="controls">
      <div class="search">
        <input id="q" placeholder="æœå°‹ï¼šåç¨± / ç·¨è™Ÿ / é—œéµå­—..." />
      </div>
      <div class="cats" id="cats"></div>
    </div>

    <div class="meta" id="meta"></div>

    <div class="grid" id="grid"></div>
    <div id="empty" class="empty" style="display:none;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“ã€‚</div>
  </div>

<script>
(() => {
  // âœ… ä½ çš„ SHEET_ID
  const SHEET_ID = "1CFUndaTaa_idLh82JxHp6AXCWPTAUFM8AzGW9NIryIA";

  // Google Visualization JSON endpoint
  const gviz = (sheet) =>
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheet)}&tqx=out:json`;

  const $ = (id) => document.getElementById(id);

  let allProducts = [];
  let activeCat = "å…¨éƒ¨";
  let cats = ["å…¨éƒ¨"];

  // ---------- helpers ----------
  function safeText(v){ return (v === null || v === undefined) ? "" : String(v).trim(); }
  function isTRUE(v){
    const s = safeText(v).toUpperCase();
    return s === "TRUE";
  }
  function toNumber(v){
    const s = safeText(v).replace(/[^\d.-]/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }
  function fmtMoney(n, currency="TWD"){
    if(n === null) return "";
    // ä½ ç›®å‰é¡¯ç¤º NT$ï¼Œå…ˆé– TWD ç”¨ NT$
    if(currency === "TWD") return `NT$ ${Math.round(n)}`;
    return `${currency} ${Math.round(n)}`;
  }

  // è§£æ gviz å›å‚³
  function parseGviz(text){
    const jsonText = text
      .replace(/^\s*\/\*O_o\*\/\s*/,'')
      .replace(/^\s*google\.visualization\.Query\.setResponse\(/,'')
      .replace(/\);\s*$/,'');
    const obj = JSON.parse(jsonText);
    const table = obj.table;
    const headers = table.cols.map(c => (c.label || "").trim());
    const rows = (table.rows || []).map(r => {
      const o = {};
      (r.c || []).forEach((cell, i) => {
        o[headers[i] || ("col"+i)] = cell ? (cell.v ?? "") : "";
      });
      return o;
    });
    return { headers, rows };
  }

  // options: "é¡è‰²:é»‘=0|æ£•=0;ç‰ˆæœ¬:æ¨™æº–=0|åŠ å¤§=150"
  function parseOptions(str){
    const raw = safeText(str);
    if(!raw) return [];
    const groups = raw
      .split(";")
      .map(s => s.trim())
      .filter(Boolean);

    const out = [];
    for(const g of groups){
      const idx = g.indexOf(":");
      if(idx === -1) continue;
      const key = g.slice(0, idx).trim();
      const rest = g.slice(idx+1).trim();
      if(!key || !rest) continue;

      const items = rest.split("|").map(s => s.trim()).filter(Boolean).map(pair => {
        const [name, add] = pair.split("=").map(x => (x||"").trim());
        const addN = toNumber(add);
        return { name, add: (addN && addN !== 0) ? addN : 0 };
      }).filter(x => x.name);

      if(items.length) out.push({ key, items });
    }
    return out;
  }

  function optionsToLines(optionGroups){
    // é¡è‰²ï¼šé»‘ã€æ£•
    // ç‰ˆæœ¬ï¼šæ¨™æº–ã€åŠ å¤§ï¼ˆ+150ï¼‰
    return optionGroups.map(g => {
      const itemsText = g.items.map(it => it.add ? `${it.name}ï¼ˆ+${Math.round(it.add)}ï¼‰` : it.name).join("ã€");
      return { k: g.key, v: itemsText };
    });
  }

  // Markdownï¼ˆå…¬å‘Šç”¨ï¼‰
  function renderMarkdown(md){
    const raw = safeText(md);
    if(!raw) return "";
    // marked é è¨­ä¸æŠŠå–®ç´”æ›è¡Œç•¶ <br>ï¼Œé€™è£¡é–‹å•Ÿ breaks
    marked.setOptions({ breaks: true });
    return marked.parse(raw);
  }

  // ---------- UI ----------
  function renderCats(){
    const box = $("cats");
    box.innerHTML = "";
    cats.forEach(c => {
      const b = document.createElement("div");
      b.className = "chip" + (c === activeCat ? " active" : "");
      b.textContent = c;
      b.onclick = () => {
        activeCat = c;
        renderCats();
        renderGrid();
      };
      box.appendChild(b);
    });
  }

  function productMatches(p, q){
    if(!q) return true;
    const hay = [
      p.name, p.sku, p.search_keyword, p.note, p.spec, p.category_path
    ].map(safeText).join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function productInCat(p){
    if(activeCat === "å…¨éƒ¨") return true;
    return safeText(p.category_path) === activeCat;
  }

  function statusBadge(status){
    // åªåšä½ æœ¬ä¾†å°±ç”¨åˆ°çš„å¹¾ç¨®
    const s = safeText(status);
    if(s === "sold_out") return `<span class="badge status sold">å”®å®Œ</span>`;
    if(s === "preorder") return `<span class="badge status pre">é è³¼</span>`;
    // é è¨­ç•¶ä½œå¯è³¼è²·
    return `<span class="badge status">å¯è³¼è²·</span>`;
  }

  function computeBasePrice(p){
    // âœ… æ–¹æ¡ˆ1ï¼šprice_overrideï¼ˆç‰¹åƒ¹ï¼‰æœ‰å¡«å°±ç›´æ¥è¦†è“‹åŸºç¤åƒ¹
    const override = toNumber(p.price_override);
    const base = toNumber(p.price);
    return (override !== null) ? override : base;
  }

  function renderGrid(){
    const q = $("q").value.trim();
    const list = allProducts
      .filter(p => productInCat(p))
      .filter(p => productMatches(p, q));

    $("meta").textContent = `é¡¯ç¤º ${list.length} ç­†`;
    const grid = $("grid");
    grid.innerHTML = "";
    $("empty").style.display = list.length ? "none" : "block";

    for(const p of list){
      const card = document.createElement("div");
      card.className = "card";

      const img = safeText(p.image_url) || "https://placehold.co/1200x800/png?text=%20";
      const name = safeText(p.name) || "(æœªå‘½å)";
      const sku = safeText(p.sku) || "";
      const status = safeText(p.status) || "in_stock";
      const currency = safeText(p.currency) || "TWD";

      const base = toNumber(p.price);
      const override = toNumber(p.price_override);
      const displayBase = computeBasePrice(p);

      // list ä¸Šé¡¯ç¤º spec + optionsï¼ˆæ²’å¡«å°±ä¸é¡¯ç¤ºï¼‰
      const spec = safeText(p.spec);
      const optGroups = parseOptions(p.options);
      const optLines = optionsToLines(optGroups);

      // åƒ¹æ ¼å€å¡Šï¼šå¦‚æœæœ‰ç‰¹åƒ¹ï¼Œé¡¯ç¤ºèˆŠåƒ¹åˆªé™¤ç·š + ç‰¹åƒ¹ badgeï¼›å¦å‰‡é¡¯ç¤ºä¸€èˆ¬ badge
      let priceHTML = "";
      if(override !== null && base !== null && override !== base){
        priceHTML = `
          <span class="oldprice">${fmtMoney(base, currency)}</span>
          <span class="badge special">ğŸ”¥ ç‰¹åƒ¹ ${fmtMoney(override, currency)}</span>
        `;
      }else{
        priceHTML = `<span class="badge price">${fmtMoney(displayBase, currency)}</span>`;
      }

      const detailsLines = [];
      if(spec){
        detailsLines.push(`<span class="line"><span>è¦æ ¼ï¼š</span>${escapeHtml(spec)}</span>`);
      }
      for(const l of optLines){
        detailsLines.push(`<span class="line"><span>${escapeHtml(l.k)}ï¼š</span>${escapeHtml(l.v)}</span>`);
      }

      const disabled = (status === "sold_out" || status === "hidden");

      card.innerHTML = `
        <div class="thumb">
          <img src="${escapeAttr(img)}" alt="${escapeAttr(name)}" loading="lazy" />
        </div>
        <div class="body">
          <div>
            <p class="name">${escapeHtml(name)}</p>
            <p class="sku">ç·¨è™Ÿï¼š${escapeHtml(sku)}</p>
          </div>

          <div class="row">
            ${statusBadge(status)}
          </div>

          <div class="row">
            ${priceHTML}
          </div>

          ${detailsLines.length ? `<div class="details">${detailsLines.join("")}</div>` : `<div class="details" style="display:none;"></div>`}

          <div class="cta">
            <button class="btn ${disabled ? "disabled":""}" ${disabled ? "disabled":""}
              onclick="location.href='product.html?sku=${encodeURIComponent(sku)}'">
              æŸ¥çœ‹ / é¸é …
            </button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function escapeAttr(s){ return escapeHtml(s); }

  // ---------- load data ----------
  async function loadSheet(sheetName){
    const res = await fetch(gviz(sheetName), { cache: "no-store" });
    const text = await res.text();
    return parseGviz(text);
  }

  async function init(){
    // 1) Public: å…¬å‘Š
    try{
      const pub = await loadSheet("Public");
      // æœŸå¾…æ¬„ä½ï¼šenabled sort key title content
      const row = pub.rows.find(r => safeText(r.key) === "products_banner" && isTRUE(r.enabled));
      if(row){
        $("bannerTitle").textContent = safeText(row.title) || "å…¬å‘Š";
        const html = renderMarkdown(row.content);
        $("bannerContent").innerHTML = html || "";
        $("banner").style.display = "block";
      }else{
        // æ²’è³‡æ–™å°±ä¸é¡¯ç¤ºæ•´å¡Šï¼Œé¿å…åªæœ‰ã€Œå…¬å‘Šã€å››å€‹å­—å°·å°¬èººå¹³
        $("banner").style.display = "none";
      }
    }catch(e){
      $("banner").style.display = "none";
      console.warn("Public load failed:", e);
    }

    // 2) Products
    const prod = await loadSheet("Products");

    // âœ… åªèª enabled === TRUE çš„åˆ—ï¼Œå…¶ä»–ä¸€å¾‹å¿½ç•¥ï¼ˆä½ è¦æ±‚ï¼‰
    const products = prod.rows
      .filter(r => isTRUE(r.enabled))
      .filter(r => safeText(r.sku)) // sku å¿…å¡«æ‰ç®—å•†å“
      .map(r => ({
        sort: r.sort,
        enabled: r.enabled,
        sku: safeText(r.sku),
        category_path: safeText(r.category_path),
        name: safeText(r.name),
        status: safeText(r.status) || "in_stock",
        spec: safeText(r.spec),
        options: safeText(r.options),
        note: safeText(r.note),
        price: r.price,
        price_override: r.price_override,   // âœ… ç‰¹åƒ¹æ¬„ä½
        currency: safeText(r.currency) || "TWD",
        search_keyword: safeText(r.search_keyword),
        image_url: safeText(r.image_url),
      }));

    allProducts = products;

    // 3) categoriesï¼šå„ªå…ˆ Categories sheetï¼Œæ²’æœ‰å°±å¾å•†å“è‡ªå‹•ç”Ÿ
    let catList = [];
    try{
      const cat = await loadSheet("Categories");
      // ç›¡é‡å…¼å®¹ï¼šåªè¦æœ‰ name ä¸” enabled true
      catList = cat.rows
        .filter(r => isTRUE(r.enabled))
        .map(r => safeText(r.name))
        .filter(Boolean);
    }catch(e){
      catList = [];
    }

    if(!catList.length){
      const set = new Set(products.map(p => p.category_path).filter(Boolean));
      catList = Array.from(set);
    }

    // æŠŠç©ºç™½åˆ†é¡ç§»é™¤ã€å›ºå®šã€Œå…¨éƒ¨ã€åœ¨æœ€å‰
    cats = ["å…¨éƒ¨", ...catList.filter(c => c && c !== "å…¨éƒ¨")];

    renderCats();
    renderGrid();

    $("q").addEventListener("input", () => renderGrid());
  }

  init();
})();
</script>

</body>
</html>

