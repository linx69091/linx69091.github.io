<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>商品 / 作品</title>

<style>
:root{
  --accent:#0b69ff;
  --muted:#6b7280;
}
body{
  font-family:"Helvetica Neue",Arial,"Noto Sans TC",sans-serif;
  margin:0;
}
.wrap{
  max-width:1100px;
  margin:24px auto;
  padding:18px;
}
.top{
  display:flex;
  justify-content:space-between;
  margin-bottom:12px;
}
.banner{
  border:1px solid #eef2f7;
  background:#f7f9fc;
  border-radius:12px;
  padding:14px;
  margin-bottom:16px;
}
.controls{
  display:flex;
  gap:10px;
  margin-bottom:16px;
  flex-wrap:wrap;
}
input[type=search]{
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  min-width:240px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:14px;
}
.card{
  border:1px solid #eee;
  border-radius:14px;
  padding:12px;
}
.thumb{
  height:150px;
  border-radius:10px;
  background:#f3f6fb;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-bottom:10px;
  overflow:hidden;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.name{
  font-weight:800;
}
.meta{
  color:var(--muted);
  font-size:14px;
  margin-top:4px;
  line-height:1.45;
}
.statusline{
  display:flex;
  gap:10px;
  margin-top:8px;
}
.badge{
  font-size:14px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #e5e7eb;
  font-weight:700;
}
.badge.price{
  font-size:16px;
  font-weight:800;
  color:#0b69ff;
  border-color:#cfe2ff;
  background:#f1f6ff;
}
.badge.soldout{
  border-color:#fecaca;
  color:#b91c1c;
}
.badge.preorder{
  border-color:#fde68a;
  color:#92400e;
  background:#fffbeb;
}
.btn{
  display:inline-block;
  margin-top:10px;
  padding:8px 10px;
  border-radius:10px;
  background:var(--accent);
  color:#fff;
  font-weight:800;
  text-decoration:none;
}
.btn.disabled{
  background:#ccc;
  pointer-events:none;
}
</style>
</head>
<body>

<div class="wrap">
  <div class="top">
    <a href="/index.html">← 回首頁</a>
    <div>商品 / 作品</div>
  </div>

  <div id="banner" class="banner" style="display:none;"></div>

  <div class="controls">
    <input id="q" type="search" placeholder="搜尋：名稱 / 編號 / 關鍵字…">
  </div>

  <div class="grid" id="grid"></div>
</div>

<script>

const SHEET_ID="1CFUndaTaa_idLh82JxHp6AXCWPTAUFM8AzGW9NIryIA";
const SHEET_PRODUCTS="Products";
const SHEET_PUBLIC="Public";

function gvizUrl(name){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${name}&tqx=out:json`;
}

async function fetchSheet(name){
  const r=await fetch(gvizUrl(name),{cache:"no-store"});
  const t=await r.text();
  const j=JSON.parse(t.substring(t.indexOf("{"),t.lastIndexOf("}")+1));
  const cols=j.table.cols.map(c=>c.label);
  return j.table.rows.map(r=>{
    const o={};
    r.c.forEach((c,i)=>o[cols[i]]=c?c.v:"");
    return o;
  });
}

function escapeHtml(s){
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function optionsToText(str){
  if(!str) return [];
  return str.split(";").map(x=>x.trim()).filter(Boolean).map(g=>{
    const [n,rest]=g.split(":");
    if(!n||!rest) return null;
    const items=rest.split("|").map(i=>{
      const [v,d]=i.split("=");
      return Number(d)>0?`${v}（+${d}）`:v;
    });
    return {name:n.trim(),items};
  }).filter(Boolean);
}

function statusLabel(s){
  if(s==="sold_out") return "售完";
  if(s==="preorder") return "預購";
  return "可購買";
}

function statusClass(s){
  if(s==="sold_out") return "soldout";
  if(s==="preorder") return "preorder";
  return "";
}

let PRODUCTS=[];

function render(){
  const q=document.getElementById("q").value.toLowerCase();
  const grid=document.getElementById("grid");
  grid.innerHTML="";

  const list=PRODUCTS
    // ✅ 只認 enabled === TRUE
    .filter(p=>String(p.enabled).toUpperCase().trim()==="TRUE")
    .filter(p=>String(p.status||"")!=="hidden")
    .filter(p=>{
      const text=(p.name+p.sku+p.search_keyword+p.category_path).toLowerCase();
      return text.includes(q);
    });

  for(const p of list){
    const status=p.status||"in_stock";
    const sold=status==="sold_out";

    const opt=optionsToText(p.options||"");

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="thumb">${p.image_url?`<img src="${p.image_url}">`:"無圖片"}</div>
      <div class="name">${escapeHtml(p.name)}</div>
      <div class="meta">編號：${escapeHtml(p.sku)}</div>

      <div class="statusline">
        <span class="badge ${statusClass(status)}">${statusLabel(status)}</span>
        <span class="badge price">NT$ ${p.price}</span>
      </div>

      ${p.spec?`<div class="meta">規格：${escapeHtml(p.spec)}</div>`:""}

      ${
        opt.length?
        `<div class="meta">
          ${opt.map(g=>`${g.name}：${g.items.join("、")}`).join("<br>")}
        </div>`:""
      }

      ${p.note?`<div class="meta">${escapeHtml(p.note)}</div>`:""}

      <a class="btn ${sold?"disabled":""}" href="/product.html?sku=${p.sku}">
        ${sold?"已售完":"查看 / 選項"}
      </a>
    `;
    grid.appendChild(card);
  }
}

async function init(){
  const [products,pub]=await Promise.all([
    fetchSheet(SHEET_PRODUCTS),
    fetchSheet(SHEET_PUBLIC)
  ]);
  PRODUCTS=products;

  const bannerRow=pub.find(r=>String(r.key).trim()==="products_banner" && String(r.enabled).toUpperCase()==="TRUE");
  if(bannerRow){
    const box=document.getElementById("banner");
    box.style.display="block";
    box.innerHTML=`<h3>${bannerRow.title}</h3>${bannerRow.content_md||""}`;
  }

  document.getElementById("q").addEventListener("input",render);
  render();
}

init();

</script>
</body>
</html>
