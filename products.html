<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å•†å“ / ä½œå“</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --blue:#1a73e8;
      --blue-weak:#e8f1ff;
      --red:#d93025;
      --red-weak:#ffe9e9;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    a{color:inherit;text-decoration:none}
    .wrap{
      max-width:1400px;
      margin:24px auto 60px;
      padding:0 18px;
    }

    /* top */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
      color:#374151;
      font-weight:600;
    }
    .topbar a{opacity:.85}
    .topbar a:hover{opacity:1}

    /* banner */
    .banner{
      background:#f0f2f5;
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 18px;
      margin:12px 0 14px;
    }
    .banner h3{
      margin:0 0 10px;
      font-size:20px;
      letter-spacing:.5px;
    }
    /* âœ… å…¬å‘Šæ›è¡Œï¼šé€™è¡Œæ˜¯é‡é» */
    #bannerContent{
      white-space:pre-line;
      line-height:1.7;
      color:#111827;
    }
    #bannerContent ul{margin:8px 0 0 20px}
    #bannerContent li{margin:4px 0}

    /* search + categories */
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      margin:10px 0 14px;
    }
    .search{
      flex:1;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      font-size:15px;
      background:transparent;
    }
    .cats{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width:260px;
    }
    .chip{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:999px;
      padding:8px 12px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      color:#111827;
      user-select:none;
    }
    .chip.active{
      border-color:#a7c3ff;
      background:#eef4ff;
      color:#1a5bd8;
    }

    /* grid: ä½ ç¾åœ¨ä¸€æ’ 5 å€‹å°±ç¶­æŒï¼Œé€™è£¡ç”¨ auto-fit */
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 2px 10px rgba(0,0,0,.03);
      display:flex;
      flex-direction:column;
      min-height:410px;
    }
    .thumb{
      background:#f3f4f6;
      aspect-ratio:16/10;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .content{
      padding:14px 14px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .name{
      font-size:20px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .sku{
      color:var(--muted);
      font-size:14px;
      font-weight:700;
    }

    .badges{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:14px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      white-space:nowrap;
    }
    .badge.stock{
      background:var(--blue-weak);
      border-color:#bcd4ff;
      color:#1a5bd8;
    }

    /* åƒ¹æ ¼ï¼šç¶­æŒä½ åŸæœ¬é‚£ç¨®å¤§å°æ„Ÿï¼Œç‰¹åƒ¹ä¸æ”¾å¤§ */
    .priceRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .price{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      border:1px solid #bcd4ff;
      background:var(--blue-weak);
      color:#1a5bd8;
      font-size:20px; /* åŸæœ¬é‚£é¡† NT$ 333 çš„å¤§å° */
      line-height:1;
    }
    .oldPrice{
      color:#9ca3af;
      text-decoration:line-through;
      font-weight:900;
      font-size:14px;
      padding:0;
      border:none;
      background:transparent;
    }
    .specialPrice{
      border:1px solid #ffb4b4;
      background:var(--red-weak);
      color:var(--red);
      font-size:20px; /* âœ… è·ŸåŸæœ¬ price åŒå¤§å°ï¼Œä¸æ”¾å¤§ */
      line-height:1;
    }

    .meta{
      color:#4b5563;
      font-size:14px;
      line-height:1.5;
      min-height:52px;
    }
    .meta .line{margin:4px 0}

    .btn{
      margin-top:auto;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      background:var(--blue);
      color:#fff;
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
    }

    .foot{
      margin-top:10px;
      color:#6b7280;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a href="./index.html">â† å›é¦–é </a>
      <a href="./cart.html">å‰å¾€è³¼ç‰©è»Š â†’</a>
    </div>

    <div class="banner">
      <h3>å…¬å‘Š</h3>
      <div id="bannerContent"></div>
    </div>

    <div class="row">
      <div class="search">
        <input id="q" placeholder="æœå°‹ï¼šåç¨± / ç·¨è™Ÿ / é—œéµå­—..." />
      </div>
      <div class="cats" id="cats"></div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="foot" id="count"></div>
  </div>

<script>
  const SHEET_ID = "1CFUndaTaa_idLh82JxHp6AXCWPTAUFM8AzGW9NIryIA";
  const BASE = `https://opensheet.elk.sh/${SHEET_ID}`;

  const state = {
    products: [],
    categories: [],
    activeCat: "å…¨éƒ¨",
    q: ""
  };

  function isTrue(v){
    return String(v ?? "").trim().toUpperCase() === "TRUE";
  }

  function safeText(v){
    return String(v ?? "").trim();
  }

  // âœ… å…¬å‘Šï¼šä»¥ key=products_banner ç‚ºä¸»ï¼Œæ‰¾ä¸åˆ°å°±æŠ“ç¬¬ä¸€ç­† enabled=TRUE
  async function loadBanner(){
    const el = document.getElementById("bannerContent");
    el.textContent = ""; // reset

    let rows = [];
    try{
      const res = await fetch(BASE + "/Public");
      rows = await res.json();
    }catch(e){
      el.textContent = "";
      return;
    }

    // å¿½ç•¥è¡¨é ­/ç¯„ä¾‹åˆ—ï¼šåªçœ‹ enabled=TRUE
    const enabledRows = rows.filter(r => isTrue(r.enabled));

    const bannerRow =
      enabledRows.find(r => safeText(r.key) === "products_banner")
      || enabledRows[0];

    const content = safeText(bannerRow?.content);

    if(!content){
      el.textContent = "";
      return;
    }

    // ç°¡å–®è™•ç†ï¼šæ”¯æ´æ›è¡Œã€- é–‹é ­è®Šæˆé …ç›®ç¬¦è™Ÿ
    // ä½ çš„ emoji æœƒåŸæ¨£ä¿ç•™
    const lines = content.split(/\r?\n/);

    // å¦‚æœçœ‹èµ·ä¾†åƒæ¸…å–®ï¼ˆå¾ˆå¤šè¡Œç”¨ - é–‹é ­ï¼‰ï¼Œå°±è½‰æˆ <ul>
    const isList = lines.filter(l => l.trim().startsWith("-")).length >= 2;

    if(isList){
      const head = [];
      const items = [];
      for(const line of lines){
        const t = line.trim();
        if(!t) continue;
        if(t.startsWith("-")){
          items.push(t.replace(/^-+\s*/, ""));
        }else{
          head.push(t);
        }
      }
      let html = "";
      if(head.length) html += head.map(h => `<div>${escapeHtml(h)}</div>`).join("");
      if(items.length){
        html += "<ul>" + items.map(i => `<li>${escapeHtml(i)}</li>`).join("") + "</ul>";
      }
      el.innerHTML = html;
    }else{
      // ä¿ç•™æ›è¡Œ
      el.textContent = content;
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // âœ… optionsï¼šæ¯å€‹ç¾¤çµ„æ›è¡Œï¼Œé¡¯ç¤ºã€Œã€ã€åˆ†éš”
  // ä¾‹ï¼šé¡è‰²:é»‘=0|æ£•=0;ç‰ˆæœ¬:æ¨™æº–=0|åŠ å¤§=150
  function optionsToHtml(text){
    const raw = safeText(text);
    if(!raw) return "";

    const groups = raw.split(";").map(s=>s.trim()).filter(Boolean);
    const lines = [];

    for(const g of groups){
      const idx = g.indexOf(":");
      if(idx === -1) continue;

      const label = g.slice(0, idx).trim();
      const values = g.slice(idx+1).trim();
      if(!label || !values) continue;

      const items = values.split("|").map(x=>x.trim()).filter(Boolean).map(x=>{
        const [name, price] = x.split("=").map(y => (y??"").trim());
        if(!name) return "";
        if(price && price !== "0"){
          return `${escapeHtml(name)}ï¼ˆ+${escapeHtml(price)}ï¼‰`;
        }
        return escapeHtml(name);
      }).filter(Boolean);

      if(items.length){
        lines.push(`<div class="line">${escapeHtml(label)}ï¼š${items.join("ã€")}</div>`);
      }
    }

    return lines.join("");
  }

  // âœ… åˆ†é¡ï¼šå„ªå…ˆè®€ Categories sheet
  // å¦‚æœ Categories æ²’è³‡æ–™ï¼Œå°±å¾ products.category_path è‡ªå‹•ç”Ÿå‡º
  async function loadCategories(){
    let rows = [];
    try{
      const res = await fetch(BASE + "/Categories");
      rows = await res.json();
    }catch(e){
      rows = [];
    }

    const enabled = rows.filter(r => isTrue(r.enabled));

    // å¸¸è¦‹æ¬„ä½åå®¹éŒ¯ï¼šname/titleã€path/category_path/key
    const cats = enabled.map(r => ({
      name: safeText(r.name || r.title || r.category || r.label),
      path: safeText(r.path || r.category_path || r.key || r.value),
      sort: Number(r.sort || 9999)
    })).filter(c => c.name && c.path);

    cats.sort((a,b)=>a.sort-b.sort);

    state.categories = cats;
  }

  async function loadProducts(){
    const res = await fetch(BASE + "/Products");
    const rows = await res.json();

    // åªèª enabled=TRUEï¼Œä¸”ç•¥éè¡¨é ­/ç¯„ä¾‹åˆ—ï¼ˆenabled ä¸æ˜¯ TRUE å°±ä¸æœƒé€²ä¾†ï¼‰
    state.products = rows.filter(r => isTrue(r.enabled)).map(r => ({
      sku: safeText(r.sku),
      name: safeText(r.name),
      category: safeText(r.category_path),
      spec: safeText(r.spec),
      options: safeText(r.options),
      note: safeText(r.note),
      price: Number(r.price || 0),
      currency: safeText(r.currency || "TWD"),
      price_override: Number(r.price_override || 0),
      image_url: safeText(r.image_url || r.image || "")
    }));
  }

  function buildCategoryUI(){
    const el = document.getElementById("cats");
    el.innerHTML = "";

    const chips = [];

    // å…ˆæ”¾ã€Œå…¨éƒ¨ã€
    chips.push({name:"å…¨éƒ¨", path:"__ALL__"});

    if(state.categories.length){
      for(const c of state.categories){
        chips.push({name:c.name, path:c.path});
      }
    }else{
      // æ²’ Categories sheet å°±ç”¨ products çš„ category_path ç”Ÿ
      const set = new Set(state.products.map(p=>p.category).filter(Boolean));
      for(const path of Array.from(set)){
        chips.push({name:path, path});
      }
    }

    for(const c of chips){
      const btn = document.createElement("div");
      btn.className = "chip" + ((state.activeCat === c.name) ? " active" : "");
      btn.textContent = c.name;
      btn.onclick = () => {
        state.activeCat = c.name;
        document.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        render();
      };
      el.appendChild(btn);
    }
  }

  function passFilter(p){
    const q = state.q.trim().toLowerCase();
    if(q){
      const hay = `${p.name} ${p.sku} ${p.note}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(state.activeCat !== "å…¨éƒ¨"){
      // activeCat æ˜¯é¡¯ç¤ºæ–‡å­—ï¼›è‹¥ Categories æœ‰è¨­å®šï¼Œé¡¯ç¤ºåå¯èƒ½ä¸æ˜¯ path
      // æ‰€ä»¥é€™è£¡ï¼šè‹¥ Categories æœ‰è³‡æ–™ï¼Œæ‰¾å°æ‡‰ pathï¼›æ‰¾ä¸åˆ°å°±ç›´æ¥ç”¨åç¨±æ¯”å°
      if(state.categories.length){
        const target = state.categories.find(c => c.name === state.activeCat);
        const path = target?.path || state.activeCat;
        if(p.category !== path) return false;
      }else{
        if(p.category !== state.activeCat) return false;
      }
    }
    return true;
  }

  function render(){
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    const list = state.products.filter(passFilter);

    for(const p of list){
      const card = document.createElement("div");
      card.className = "card";

      const hasSpecial = !!p.price_override && p.price_override > 0;

      const priceHTML = hasSpecial
        ? `
          <div class="priceRow">
            <span class="oldPrice">NT$ ${p.price}</span>
            <span class="price specialPrice">ğŸ”¥ ç‰¹åƒ¹ NT$ ${p.price_override}</span>
          </div>
        `
        : `
          <div class="priceRow">
            <span class="price">NT$ ${p.price}</span>
          </div>
        `;

      const optHTML = optionsToHtml(p.options);
      const metaLines = [
        p.spec ? `<div class="line">è¦æ ¼ï¼š${escapeHtml(p.spec)}</div>` : "",
        optHTML ? optHTML : ""
      ].filter(Boolean).join("");

      card.innerHTML = `
        <div class="thumb">
          <img src="${escapeHtml(p.image_url)}" alt="">
        </div>
        <div class="content">
          <div>
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="sku">ç·¨è™Ÿï¼š${escapeHtml(p.sku)}</div>
          </div>

          <div class="badges">
            <span class="badge stock">å¯è³¼è²·</span>
          </div>

          ${priceHTML}

          <div class="meta">
            ${metaLines || ""}
          </div>

          <button class="btn" onclick="location.href='./product.html?sku=${encodeURIComponent(p.sku)}'">æŸ¥çœ‹ / é¸é …</button>
        </div>
      `;

      grid.appendChild(card);
    }

    document.getElementById("count").textContent = `é¡¯ç¤º ${list.length} ç­†`;
  }

  // search
  document.getElementById("q").addEventListener("input", (e)=>{
    state.q = e.target.value || "";
    render();
  });

  (async function init(){
    await Promise.all([loadBanner(), loadProducts(), loadCategories()]);
    buildCategoryUI();
    render();
  })();
</script>
</body>
</html>


