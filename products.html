<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•†å“ / ä½œå“</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#1d4ed8;
      --primary-weak:#e8f0ff;
      --danger:#dc2626;
      --danger-weak:#ffe8e8;
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 18px 40px;
    }

    /* header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .topbar a{
      color:#111;
      font-weight:600;
    }

    /* announcement */
    .announce{
      background: #f3f4f6;
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 18px;
      margin: 10px 0 14px;
    }
    .announce h2{
      margin:0 0 10px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .announce .content{
      color:#111827;
      font-size: 15px;
      line-height: 1.7;
      white-space: normal;
    }
    .announce .content ul{
      margin: 8px 0 0 18px;
      padding:0;
    }
    .announce .content li{
      margin: 4px 0;
    }

    /* search + categories (æœå°‹åœ¨ä¸Šï¼Œåˆ†é¡åœ¨ä¸‹) */
    .controls{
      margin: 10px 0 14px;
    }
    .searchbox{
      width:100%;
      background:var(--card);
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 12px 16px;
      font-size: 15px;
      outline:none;
    }
    .cats{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .pill{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 650;
      color:#111;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      border-color:#93c5fd;
      background:#eef2ff;
      color:#1d4ed8;
    }

    /* grid */
    .grid{
      display:grid;
      gap:18px;
      /* é€™è£¡ç”¨ auto-fitï¼Œä¸æœƒå› åˆ†é¡å¾Œåªå‰©1å€‹å•†å“å°±ã€Œæ’çˆ†ã€æ•´é  */
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      align-items: stretch;
    }

    /* card */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 100%;
    }

    /* âœ… å›ºå®šç¸®åœ–æ¯”ä¾‹ï¼Œé¿å…åˆ†é¡é çˆ†å¤§åœ– */
    .thumb{
      width:100%;
      aspect-ratio: 4 / 3;
      background:#f8fafc;
      border-bottom:1px solid var(--border);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
    }

    .card-body{
      padding: 14px 14px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .title{
      font-size: 22px;
      font-weight: 900;
      margin:0;
      line-height: 1.15;
    }
    .sku{
      margin:0;
      color:var(--muted);
      font-weight:600;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* badges */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding: 6px 10px;
      font-weight:800;
      border:1px solid var(--border);
      background:#fff;
      line-height: 1;
      white-space:nowrap;
    }
    /* ä½ èªªã€Œå¯è³¼è²·ã€å¤ªå¤§ï¼šé€™è£¡å›ºå®šå›è¼ƒå°å­—ç´š */
    .badge.status{
      font-size: 12px;
      padding: 6px 10px;
      border-color:#bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
    }

    /* åƒ¹æ ¼ï¼šç¶­æŒåŸºæœ¬åƒ¹åŸæœ¬å¤§å°ï¼Œä¸å¦å¤–æ”¾å¤§ç‰¹åƒ¹ */
    .badge.price{
      font-size: 20px;
      padding: 8px 12px;
      border-color:#bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
    }
    .price-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .base-strike{
      color:#9ca3af;
      text-decoration: line-through;
      font-weight:800;
    }
    .badge.sale{
      /* âœ… ä¸æ”¾å¤§å­—ï¼Œè·Ÿ badge.price ä¸€æ¨£å¤§å°ç³»çµ± */
      font-size: 20px;
      padding: 8px 12px;
      border-color:#fecaca;
      background: #fff1f2;
      color: var(--danger);
    }

    .meta{
      color:#374151;
      font-size: 14px;
      line-height: 1.6;
    }

    /* âœ… options æ›è¡Œï¼šæ¯å€‹ç¾¤çµ„ä¸€è¡Œï¼ˆé¡è‰²/ç‰ˆæœ¬â€¦ï¼‰ */
    .opts{
      margin-top: 2px;
      color:#374151;
      font-size:14px;
      line-height:1.6;
      white-space: normal;
    }
    .opts .line{ display:block; }

    /* button */
    .btn{
      width:100%;
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight:900;
      font-size: 16px;
      background: #1a73e8;
      color:#fff;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }

    /* footer count */
    .count{
      margin-top: 14px;
      color: var(--muted);
      font-weight: 650;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a href="./index.html">â† å›é¦–é </a>
      <a href="./cart.html">å‰å¾€è³¼ç‰©è»Š â†’</a>
    </div>

    <!-- å…¬å‘Š -->
    <section class="announce" id="announce" style="display:none;">
      <h2 id="announceTitle">å…¬å‘Š</h2>
      <div class="content" id="announceContent"></div>
    </section>

    <!-- æœå°‹ + åˆ†é¡ï¼ˆæœå°‹åœ¨ä¸Šï¼Œåˆ†é¡åœ¨ä¸‹ï¼‰ -->
    <section class="controls">
      <input id="q" class="searchbox" placeholder="æœå°‹ï¼šåç¨± / ç·¨è™Ÿ / é—œéµå­—â€¦" />
      <div class="cats" id="cats"></div>
    </section>

    <!-- å•†å“åˆ—è¡¨ -->
    <section class="grid" id="grid"></section>
    <div class="count" id="count"></div>
  </div>

  <script>
    /********************
     * âœ… ä½ åªè¦æ”¹é€™è£¡
     ********************/
    const SHEET_ID = "YOUR_SHEET_ID";
    const GID_PRODUCTS   = "YOUR_GID_PRODUCTS";
    const GID_CATEGORIES = "YOUR_GID_CATEGORIES";
    const GID_PUBLIC     = "YOUR_GID_PUBLIC";

    const csvUrl = (gid) =>
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;

    /********************
     * CSV parser (ç°¡å–®ä½†å¤ ç”¨)
     ********************/
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' ){
          if (inQuotes && next === '"'){
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }
        if (!inQuotes && ch === ','){
          row.push(cur);
          cur = "";
          continue;
        }
        if (!inQuotes && (ch === '\n' || ch === '\r')){
          if (ch === '\r' && next === '\n') i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }
        cur += ch;
      }
      if (cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }
      return rows;
    }

    function rowsToObjects(rows){
      if (!rows || rows.length < 2) return [];
      const header = rows[0].map(h => (h||"").trim());
      const out = [];
      for (let i=1;i<rows.length;i++){
        const r = rows[i];
        if (r.every(c => (c||"").trim()==="")) continue;
        const obj = {};
        header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        out.push(obj);
      }
      return out;
    }

    async function fetchSheetObjects(gid){
      const res = await fetch(csvUrl(gid), { cache: "no-store" });
      const text = await res.text();
      return rowsToObjects(parseCSV(text));
    }

    /********************
     * å…¬å‘Š content_md æ¸²æŸ“ï¼ˆæ”¯æ´ - æ¸…å–® + æ›è¡Œï¼‰
     ********************/
    function renderContentMD(md){
      const lines = (md || "").split(/\r?\n/);
      const isList = lines.some(l => l.trim().startsWith("- "));
      if (isList){
        const ul = document.createElement("ul");
        lines.forEach(l => {
          const t = l.trim();
          if (!t) return;
          if (t.startsWith("- ")){
            const li = document.createElement("li");
            li.textContent = t.slice(2);
            ul.appendChild(li);
          } else {
            // é - é–‹é ­ï¼šç•¶ä½œä¸€èˆ¬æ®µè½
            const li = document.createElement("li");
            li.textContent = t;
            ul.appendChild(li);
          }
        });
        return ul;
      } else {
        // ä¸€èˆ¬æ–‡å­—ï¼šä¿ç•™æ›è¡Œ
        const div = document.createElement("div");
        div.innerHTML = (md || "")
          .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
          .replace(/\r?\n/g, "<br>");
        return div;
      }
    }

    /********************
     * options å­—ä¸²è§£æ
     * "é¡è‰²:é»‘=0|æ£•=0;ç‰ˆæœ¬:æ¨™æº–=0|åŠ å¤§=150"
     ********************/
    function parseOptions(optionsStr){
      const s = (optionsStr || "").trim();
      if (!s) return [];
      // å»å°¾ç«¯å¤šé¤˜ ;
      const clean = s.replace(/;+\s*$/,"");
      const groups = clean.split(";").map(x => x.trim()).filter(Boolean);
      return groups.map(g => {
        const [labelPart, valuesPart] = g.split(":");
        const label = (labelPart || "").trim();
        const values = (valuesPart || "").split("|").map(v => v.trim()).filter(Boolean).map(v => {
          const [name, addStr] = v.split("=");
          const add = Number((addStr || "0").trim()) || 0;
          return { name: (name||"").trim(), add };
        }).filter(x => x.name);
        return { label, values };
      }).filter(x => x.label && x.values.length);
    }

    function formatOptionsLines(groups){
      // é¡è‰²ï¼šé»‘ã€æ£•
      // ç‰ˆæœ¬ï¼šæ¨™æº–ã€åŠ å¤§ï¼ˆ+150ï¼‰
      return groups.map(g => {
        const items = g.values.map(v => v.add > 0 ? `${v.name}ï¼ˆ+${v.add}ï¼‰` : v.name);
        return `${g.label}ï¼š${items.join("ã€")}`;
      });
    }

    /********************
     * enabled åˆ¤æ–·ï¼šåªèª TRUE
     ********************/
    function isEnabledTrue(v){
      return String(v || "").trim().toUpperCase() === "TRUE";
    }

    /********************
     * ç‹€æ…‹ä¸­æ–‡ï¼ˆä½ ä¹‹å‰å•éï¼‰
     ********************/
    const STATUS_ZH = {
      in_stock: "å¯è³¼è²·",
      sold_out: "å”®å®Œ",
      preorder: "é è³¼",
      hidden: "éš±è—"
    };

    /********************
     * ä¸»æµç¨‹
     ********************/
    let PRODUCTS = [];
    let CATEGORIES = [];
    let activeCat = "å…¨éƒ¨";

    const $grid = document.getElementById("grid");
    const $count = document.getElementById("count");
    const $q = document.getElementById("q");
    const $cats = document.getElementById("cats");

    function buildCats(){
      $cats.innerHTML = "";
      const make = (name) => {
        const b = document.createElement("button");
        b.className = "pill" + (activeCat===name ? " active" : "");
        b.type = "button";
        b.textContent = name;
        b.onclick = () => {
          activeCat = name;
          [...$cats.children].forEach(x => x.classList.remove("active"));
          b.classList.add("active");
          render();
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        return b;
      };

      $cats.appendChild(make("å…¨éƒ¨"));

      // ä¾ Categories è¡¨æ’åºï¼ˆè‹¥æ²’æœ‰å°±ç”¨ç”¢å“å…§å‡ºç¾çš„åˆ†é¡ï¼‰
      const catNames = CATEGORIES.length
        ? CATEGORIES
            .filter(r => isEnabledTrue(r.enabled))
            .sort((a,b)=>(Number(a.sort)||9999)-(Number(b.sort)||9999))
            .map(r => (r.name || r.title || "").trim())
            .filter(Boolean)
        : Array.from(new Set(PRODUCTS.map(p => (p.category_path||"").trim()).filter(Boolean)));

      catNames.forEach(n => $cats.appendChild(make(n)));
    }

    function matchQuery(p, q){
      const hay = [
        p.name, p.sku, p.search_keyword, p.category_path, p.spec, p.note
      ].join(" ").toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function getDisplayPrice(p){
      const base = Number(p.price || 0) || 0;
      const override = Number(p.price_override || 0) || 0;
      const useOverride = override > 0;
      return {
        base,
        override: useOverride ? override : null
      };
    }

    function productCard(p){
      const card = document.createElement("article");
      card.className = "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      const img = document.createElement("img");
      img.alt = p.name || "";
      img.loading = "lazy";
      img.src = (p.image_url || p.image || "").trim() || "";
      thumb.appendChild(img);

      const body = document.createElement("div");
      body.className = "card-body";

      const h = document.createElement("h3");
      h.className = "title";
      h.textContent = p.name || "";

      const sku = document.createElement("p");
      sku.className = "sku";
      sku.textContent = `ç·¨è™Ÿï¼š${p.sku || "-"}`;

      const row1 = document.createElement("div");
      row1.className = "row";

      const st = (p.status || "").trim();
      const stText = STATUS_ZH[st] || st || "";
      const statusBadge = document.createElement("span");
      statusBadge.className = "badge status";
      statusBadge.textContent = stText || "å¯è³¼è²·";
      row1.appendChild(statusBadge);

      const priceWrap = document.createElement("div");
      priceWrap.className = "price-wrap";

      const { base, override } = getDisplayPrice(p);

      if (override !== null){
        const baseStrike = document.createElement("span");
        baseStrike.className = "base-strike";
        baseStrike.textContent = `NT$ ${base}`;
        priceWrap.appendChild(baseStrike);

        const sale = document.createElement("span");
        sale.className = "badge sale";
        sale.textContent = `ğŸ”¥ ç‰¹åƒ¹ NT$ ${override}`;
        priceWrap.appendChild(sale);
      } else {
        const price = document.createElement("span");
        price.className = "badge price";
        price.textContent = `NT$ ${base}`;
        priceWrap.appendChild(price);
      }
      row1.appendChild(priceWrap);

      const meta = document.createElement("div");
      meta.className = "meta";

      // è¦æ ¼
      if ((p.spec || "").trim()){
        const d = document.createElement("div");
        d.textContent = `è¦æ ¼ï¼š${p.spec.trim()}`;
        meta.appendChild(d);
      }

      // optionsï¼ˆæ›è¡Œé¡¯ç¤ºï¼‰
      const groups = parseOptions(p.options || "");
      if (groups.length){
        const opts = document.createElement("div");
        opts.className = "opts";
        const lines = formatOptionsLines(groups);
        lines.forEach(line => {
          const s = document.createElement("span");
          s.className = "line";
          s.textContent = line;
          opts.appendChild(s);
        });
        meta.appendChild(opts);
      }

      // noteï¼ˆå¦‚æœä½ æœ‰è¦é¡¯ç¤ºå°±ç•™è‘—ï¼›æ²’æœ‰å°±ä¸å‹•ï¼‰
      if ((p.note || "").trim()){
        const d = document.createElement("div");
        d.textContent = `å‚™è¨»ï¼š${p.note.trim()}`;
        meta.appendChild(d);
      }

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.type = "button";
      btn.textContent = "æŸ¥çœ‹ / é¸é …";
      btn.onclick = () => {
        // ä½ çš„è©³æƒ…é ç¶²å€å¦‚æœä¸åŒï¼Œæ”¹é€™è£¡
        const url = `./product.html?sku=${encodeURIComponent(p.sku || "")}`;
        window.location.href = url;
      };

      body.appendChild(h);
      body.appendChild(sku);
      body.appendChild(row1);
      if (meta.childNodes.length) body.appendChild(meta);
      body.appendChild(btn);

      card.appendChild(thumb);
      card.appendChild(body);
      return card;
    }

    function render(){
      const q = ($q.value || "").trim();
      let list = PRODUCTS
        .filter(p => isEnabledTrue(p.enabled))   // âœ… åªåƒ TRUE
        .filter(p => (p.status || "").trim() !== "hidden");

      if (activeCat !== "å…¨éƒ¨"){
        list = list.filter(p => (p.category_path || "").trim() === activeCat);
      }
      if (q){
        list = list.filter(p => matchQuery(p, q));
      }

      // sortï¼ˆå°åˆ°å¤§ï¼‰
      list.sort((a,b)=>(Number(a.sort)||9999)-(Number(b.sort)||9999));

      $grid.innerHTML = "";
      list.forEach(p => $grid.appendChild(productCard(p)));
      $count.textContent = `é¡¯ç¤º ${list.length} ç­†`;
    }

    async function loadAnnouncement(){
      // Public sheet: enabled, sort, key, title, content_md
      const rows = await fetchSheetObjects(GID_PUBLIC);
      const banner = rows
        .filter(r => isEnabledTrue(r.enabled))
        .filter(r => (r.key || "").trim() === "products_banner")
        .sort((a,b)=>(Number(a.sort)||9999)-(Number(b.sort)||9999))[0];

      if (!banner) return;

      const title = (banner.title || "å…¬å‘Š").trim();
      const md = (banner.content_md || "").trim();

      const $sec = document.getElementById("announce");
      const $t = document.getElementById("announceTitle");
      const $c = document.getElementById("announceContent");

      $t.textContent = title;

      // âœ… ä¹‹å‰ä½ ã€Œæœ‰æ¨™é¡Œä½†æ²’å…§å®¹ã€å°±æ˜¯é€™æ®µå¸¸è¦‹è¢«è¦†è“‹æˆ–æ²’ append
      $c.innerHTML = "";
      if (md){
        $c.appendChild(renderContentMD(md));
      } else {
        // æ²’å…§å®¹å°±æ•´å¡Šä¸é¡¯ç¤ºï¼Œé¿å…ç©ºæ¡†
        return;
      }
      $sec.style.display = "";
    }

    async function init(){
      // å…ˆè¼‰å…¬å‘Šï¼ˆä¸å½±éŸ¿å•†å“ï¼‰
      loadAnnouncement().catch(console.error);

      // è¼‰å•†å“ / åˆ†é¡
      const [products, categories] = await Promise.all([
        fetchSheetObjects(GID_PRODUCTS),
        fetchSheetObjects(GID_CATEGORIES),
      ]);

      PRODUCTS = products;
      CATEGORIES = categories;

      buildCats();
      render();

      $q.addEventListener("input", () => render());
    }

    init().catch(err => {
      console.error(err);
      document.getElementById("count").textContent = "è®€å–å¤±æ•—ï¼šè«‹æª¢æŸ¥ Sheet æ¬Šé™èˆ‡ GIDã€‚";
    });
  </script>
</body>
</html>

