<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å•†å“è©³æƒ…</title>

<style>
:root{
  --accent:#0b69ff;
  --muted:#6b7280;
  --border:#e5e7eb;
  --bg:#ffffff;
  --soft:#f7f9fc;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Helvetica Neue",Arial,"Noto Sans TC",sans-serif;
  color:#111;
  background:var(--bg);
}
a{color:inherit; text-decoration:none}
.wrap{
  max-width:1200px;
  margin:24px auto;
  padding:18px;
}
.top{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.top a{ font-weight:700; }
.layout{
  display:grid;
  grid-template-columns: 1.6fr 1fr;
  gap:16px;
}
@media (max-width: 980px){
  .layout{grid-template-columns:1fr}
}
.card{
  border:1px solid var(--border);
  border-radius:16px;
  background:#fff;
  overflow:hidden;
}
.leftPad{padding:16px}
.rightPad{padding:16px}
.hero{
  width:100%;
  aspect-ratio: 16 / 9;
  background:#f3f6fb;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.hero img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
h1{
  margin:14px 0 8px;
  font-size:34px;
  line-height:1.15;
}
.badges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin:8px 0 14px;
}
.badge{
  font-size:14px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-weight:800;
  background:#fff;
}
.badge.preorder{
  border-color:#fde68a;
  color:#92400e;
  background:#fffbeb;
}
.badge.soldout{
  border-color:#fecaca;
  color:#b91c1c;
  background:#fff5f5;
}
.badge.ok{
  border-color:#cfe2ff;
  color:#0b69ff;
  background:#f1f6ff;
}
.section{
  border-top:1px solid #f0f2f5;
  padding-top:14px;
  margin-top:14px;
}
.label{
  color:var(--muted);
  font-weight:800;
  letter-spacing:0.02em;
  margin-bottom:6px;
}
.value{
  font-size:18px;
  font-weight:800;
}
.small{
  color:var(--muted);
  font-size:14px;
  line-height:1.55;
  white-space:pre-line; /* è®“å‚™è¨»/èªªæ˜ä¿ç•™æ›è¡Œ */
}
.priceHeader{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
}
.priceBig{
  font-size:30px;
  font-weight:900;
}
hr.sep{
  border:none;
  border-top:1px solid #eef2f7;
  margin:14px 0;
}
.field{
  margin:12px 0;
}
.field label{
  display:block;
  font-weight:900;
  margin:0 0 6px;
}
select, input[type="number"]{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #dbe2ea;
  outline:none;
  font-size:16px;
  background:#fff;
}
select:focus, input[type="number"]:focus{
  border-color:#bcd4ff;
  box-shadow:0 0 0 3px rgba(11,105,255,0.10);
}
.btn{
  width:100%;
  padding:12px 14px;
  border:none;
  border-radius:12px;
  font-weight:900;
  font-size:16px;
  cursor:pointer;
}
.btn.primary{
  background:var(--accent);
  color:#fff;
}
.btn.dark{
  background:#0f172a;
  color:#fff;
  margin-top:10px;
}
.btn.disabled{
  background:#d1d5db;
  color:#111;
  cursor:not-allowed;
}
.noteBox{
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:var(--soft);
  border:1px solid #eef2f7;
  color:var(--muted);
  font-size:13px;
  line-height:1.55;
  white-space:pre-line;
}
.strike{
  text-decoration:line-through;
  color:#9ca3af;
  font-weight:800;
}
.special{
  color:#d11;
  font-weight:900;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <a href="./products.html">â† å›å•†å“åˆ—è¡¨</a>
    <a href="./cart.html">å‰å¾€è³¼ç‰©è»Š â†’</a>
  </div>

  <div class="layout">
    <!-- LEFT -->
    <div class="card">
      <div class="hero" id="hero">è®€å–ä¸­â€¦</div>

      <div class="leftPad">
        <h1 id="name">â€”</h1>

        <div class="badges" id="badges"></div>

        <div class="section">
          <div class="label">è¦æ ¼</div>
          <div class="value" id="spec">â€”</div>
        </div>

        <div class="section">
          <div class="label">å‚™è¨»</div>
          <div class="small" id="note">â€”</div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="rightPad">
        <div class="priceHeader">
          <div>
            <div class="label" style="margin:0">åƒ¹æ ¼</div>
            <div class="small" id="priceSummary">â€”</div>
          </div>
          <div class="priceBig" id="priceBig">NT$ â€”</div>
        </div>

        <hr class="sep"/>

        <div id="optionsArea"></div>

        <div class="field">
          <label for="qty">æ•¸é‡</label>
          <input id="qty" type="number" min="1" step="1" value="1" />
        </div>

        <button id="btnAdd" class="btn primary">åŠ å…¥è³¼ç‰©è»Š</button>
        <button id="btnAddGo" class="btn dark">åŠ å…¥å¾Œå‰å¾€è³¼ç‰©è»Š</button>

        <div id="hint" class="noteBox" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== è¨­å®šï¼šè·Ÿ products.html ä¸€è‡´ï¼ˆopensheetï¼‰ ====== */
const SHEET_ID = "1CFUndaTaa_idLh82JxHp6AXCWPTAUFM8AzGW9NIryIA";
const BASE = `https://opensheet.elk.sh/${SHEET_ID}`;
const ENDPOINT_PRODUCTS = BASE + "/Products";
/* ================================================ */

function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function safeText(v){ return String(v ?? "").trim(); }
function isTrue(v){ return String(v ?? "").trim().toUpperCase() === "TRUE"; }

/* ä½ åŸæœ¬çš„ status æ©Ÿåˆ¶ä¿ç•™ï¼Œä½† Products æ²’å¡«å°±ç•¶å¯è³¼è²· */
function normStatus(v){
  return String(v || "").trim() || "in_stock";
}
function statusLabel(s){
  if(s==="sold_out") return "å”®å®Œ";
  if(s==="preorder") return "é è³¼";
  return "å¯è³¼è²·";
}
function statusClass(s){
  if(s==="sold_out") return "soldout";
  if(s==="preorder") return "preorder";
  return "ok";
}

/*
options æ ¼å¼ï¼š
"é¡è‰²:é»‘=0|æ£•=0;ç‰ˆæœ¬:æ¨™æº–=0|åŠ å¤§=150"
*/
function parseOptions(str){
  if(!str) return [];
  const groups = String(str).split(";").map(x=>x.trim()).filter(Boolean);

  const out = [];
  for(const g of groups){
    const [nRaw, restRaw] = g.split(":");
    const name = (nRaw||"").trim();
    const rest = (restRaw||"").trim();
    if(!name || !rest) continue;

    const items = rest.split("|").map(x=>x.trim()).filter(Boolean).map(item=>{
      const [valRaw, deltaRaw] = item.split("=");
      const val = (valRaw||"").trim();
      const delta = Number((deltaRaw||"0").trim() || 0);
      if(!val) return null;
      return { label: val, delta, text: delta ? `${val}ï¼ˆ+${delta}ï¼‰` : val };
    }).filter(Boolean);

    if(items.length){
      out.push({ name, items });
    }
  }
  return out;
}

function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

/* ====== è³¼ç‰©è»Š localStorage ====== */
const CART_KEY="CART_V1";
function readCart(){
  try{ return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
  catch(e){ return []; }
}
function writeCart(items){
  localStorage.setItem(CART_KEY, JSON.stringify(items));
}
/* ================================ */

function money(n){
  return `NT$ ${Number(n||0)}`;
}

async function fetchProducts(){
  const r = await fetch(ENDPOINT_PRODUCTS, { cache:"no-store" });
  return await r.json();
}

(async function init(){
  const sku = getParam("sku");
  const hint = document.getElementById("hint");

  if(!sku){
    hint.style.display="block";
    hint.textContent="ç¼ºå°‘ skuã€‚è«‹å¾å•†å“åˆ—è¡¨é»é€²ä¾†ã€‚";
    document.getElementById("btnAdd").classList.add("disabled");
    document.getElementById("btnAddGo").classList.add("disabled");
    document.getElementById("btnAdd").disabled = true;
    document.getElementById("btnAddGo").disabled = true;
    return;
  }

  let rows = [];
  try{
    rows = await fetchProducts();
  }catch(e){
    hint.style.display="block";
    hint.textContent="è®€å–å•†å“è³‡æ–™å¤±æ•—ï¼ˆProductsï¼‰ã€‚è«‹ç¢ºèªè¡¨å–®å·²å…¬é–‹æˆ– opensheet å¯è®€ã€‚";
    return;
  }

  // å°é½Š products.html çš„æ¬„ä½å‘½å
  const products = rows.map(r => ({
    enabled: r.enabled,
    sku: safeText(r.sku),
    name: safeText(r.name),
    category_path: safeText(r.category_path),
    spec: safeText(r.spec),
    options: safeText(r.options),
    note: safeText(r.note),
    price: Number(r.price || 0),
    price_override: Number(r.price_override || 0),
    image_url: safeText(r.image_url || r.image || ""),
    status: safeText(r.status) // å¯èƒ½ä¸å­˜åœ¨ï¼Œä¿ç•™å…¼å®¹
  }));

  const candidates = products
    .filter(p => safeText(p.sku) === safeText(sku))
    .filter(p => isTrue(p.enabled));

  if(!candidates.length){
    hint.style.display="block";
    hint.textContent="æ‰¾ä¸åˆ°å•†å“æˆ–æœªä¸Šæ¶ï¼ˆenabled éœ€ç‚º TRUEï¼‰ã€‚";
    return;
  }

  const p = candidates[0];

  // --- åŸºç¤åƒ¹ï¼šç‰¹åƒ¹å„ªå…ˆï¼ˆè·Ÿ products.html åŒä¸€å¥—ï¼‰ ---
  const baseOriginal = Number(p.price || 0);
  const baseSpecial = Number(p.price_override || 0);
  const hasSpecial = !!p.price_override && !Number.isNaN(baseSpecial) && baseSpecial > 0;
  const base = hasSpecial ? baseSpecial : baseOriginal;

  // --- options ---
  const groups = parseOptions(p.options || "");

  // Render left
  document.title = `${p.name || "å•†å“"}ï½œå•†å“è©³æƒ…`;
  document.getElementById("name").textContent = p.name || "";
  document.getElementById("spec").textContent = p.spec ? String(p.spec) : "â€”";
  document.getElementById("note").textContent = p.note ? String(p.note) : "â€”";

  const hero = document.getElementById("hero");
  if(p.image_url){
    hero.innerHTML = `<img src="${escapeHtml(p.image_url)}" alt="${escapeHtml(p.name||"")}">`;
  }else{
    hero.textContent = "ç„¡åœ–ç‰‡";
  }

  const st = normStatus(p.status);
  const badges = document.getElementById("badges");
  badges.innerHTML = `
    <span class="badge">${escapeHtml("ç·¨è™Ÿï¼š" + (p.sku || ""))}</span>
    <span class="badge">${escapeHtml("åˆ†é¡ï¼š" + (p.category_path || "â€”"))}</span>
    <span class="badge ${statusClass(st)}">${escapeHtml(statusLabel(st))}</span>
  `;

  // Render options area
  const optionsArea = document.getElementById("optionsArea");
  optionsArea.innerHTML = "";
  const selects = [];

  for(const g of groups){
    const div = document.createElement("div");
    div.className = "field";
    const id = "opt_" + g.name;

    div.innerHTML = `
      <label for="${escapeHtml(id)}">${escapeHtml(g.name)}</label>
      <select id="${escapeHtml(id)}"></select>
    `;
    optionsArea.appendChild(div);

    const sel = div.querySelector("select");
    for(const item of g.items){
      const opt = document.createElement("option");
      opt.value = String(item.delta);
      opt.textContent = item.text;
      sel.appendChild(opt);
    }
    selects.push({ group:g.name, el: sel });
  }

  const qtyEl = document.getElementById("qty");
  const priceBig = document.getElementById("priceBig");
  const priceSummary = document.getElementById("priceSummary");

  function calcOptionDelta(){
    let sum = 0;
    for(const s of selects){
      sum += Number(s.el.value || 0);
    }
    return sum;
  }

  function buildOptionText(){
    if(!selects.length) return "";
    return selects.map(s=>{
      const label = s.el.options[s.el.selectedIndex]?.textContent || "";
      return `${s.group}ï¼š${label}`;
    }).join("ï¼›");
  }

  function renderPrice(){
    const qty = Math.max(1, Number(qtyEl.value || 1));
    const optDelta = calcOptionDelta();
    const unitPrice = base + optDelta;
    const total = unitPrice * qty;

    priceBig.textContent = money(total);

    if(hasSpecial){
      priceSummary.innerHTML = `
        <div class="strike">åŸåƒ¹ ${money(baseOriginal)}</div>
        <div class="special">ğŸ”¥ ç‰¹åƒ¹ ${money(baseSpecial)}</div>
        <div class="small" style="margin-top:6px">å–®åƒ¹ ${money(unitPrice)} Ã— ${qty}</div>
      `;
    }else{
      priceSummary.innerHTML = `
        <div>åŸºç¤åƒ¹ ${money(baseOriginal)}</div>
        <div class="small" style="margin-top:6px">å–®åƒ¹ ${money(unitPrice)} Ã— ${qty}</div>
      `;
    }

    const sold = st === "sold_out";
    document.getElementById("btnAdd").disabled = sold;
    document.getElementById("btnAddGo").disabled = sold;
    document.getElementById("btnAdd").classList.toggle("disabled", sold);
    document.getElementById("btnAddGo").classList.toggle("disabled", sold);
  }

  for(const s of selects) s.el.addEventListener("change", renderPrice);
  qtyEl.addEventListener("input", renderPrice);

  function addToCart(){
    const qty = Math.max(1, Number(qtyEl.value || 1));
    const optDelta = calcOptionDelta();
    const unitPrice = base + optDelta;

    const item = {
      sku: String(p.sku || ""),
      name: String(p.name || ""),
      category: String(p.category_path || ""),
      spec: String(p.spec || ""),
      image_url: String(p.image_url || ""),
      price_original: baseOriginal,
      price_special: hasSpecial ? baseSpecial : "",
      base_price_used: base,
      option_delta: optDelta,
      unit_price: unitPrice,
      qty,
      total: unitPrice * qty,
      options_text: buildOptionText(),
      status: st
    };

    const cart = readCart();
    cart.push(item);
    writeCart(cart);

    hint.style.display="block";
    hint.textContent = `å·²åŠ å…¥è³¼ç‰©è»Šï¼š${item.name}ï¼ˆ${qty} ä»¶ï¼‰`;
  }

  document.getElementById("btnAdd").addEventListener("click", addToCart);
  document.getElementById("btnAddGo").addEventListener("click", ()=>{
    addToCart();
    location.href = "./cart.html";
  });

  renderPrice();
})();
</script>

</body>
</html>
