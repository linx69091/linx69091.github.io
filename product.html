<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•†å“ / ä½œå“</title>

  <style>
    :root{
      --bg:#ffffff;
      --border:#e5e7eb;
      --muted:#6b7280;
      --soft:#f7f9fc;
      --accent:#0b69ff;
      --danger:#d11;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Helvetica Neue",Arial,"Noto Sans TC",sans-serif;
      color:#111;
      background:var(--bg);
    }
    a{color:inherit;text-decoration:none}

    /* âœ… è®“ä¸€è¡Œå¡å¾—ä¸‹ 5 å€‹ï¼šå®¹å™¨è®Šå¯¬ */
    .wrap{
      max-width:1600px;
      margin:24px auto;
      padding:18px;
    }

    .top{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .top a{font-weight:800}

    .banner{
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      background:var(--soft);
      margin-bottom:14px;
    }
    .banner h3{
      margin:0 0 8px;
      font-size:18px;
    }
    .banner .content{
      white-space:pre-wrap; /* âœ… å…¬å‘Šæ›è¡Œ */
      color:#111;
      line-height:1.7;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin:14px 0;
    }
    .search{
      flex:1;
      min-width:260px;
      padding:12px 14px;
      border:1px solid #dbe2ea;
      border-radius:14px;
      outline:none;
      font-size:16px;
    }
    .search:focus{
      border-color:#bcd4ff;
      box-shadow:0 0 0 3px rgba(11,105,255,0.10);
    }
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color:#bcd4ff;
      background:#f1f6ff;
      color:#0b69ff;
    }

    /* âœ… æ¡Œæ©Ÿå›åˆ° 5 æ¬„ï¼ˆå¯¬è¢å¹•ï¼‰ */
    .grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:14px;
    }
    @media (max-width: 1400px){
      .grid{grid-template-columns: repeat(4, 1fr);}
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns: repeat(3, 1fr);}
    }
    @media (max-width: 820px){
      .grid{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width: 520px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .thumb{
      width:100%;
      aspect-ratio: 16/10;
      background:#f3f6fb;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .pad{padding:14px}
    .name{
      font-size:18px;
      font-weight:900;
      margin:0 0 4px;
    }
    .sku{
      color:var(--muted);
      font-weight:800;
      margin-bottom:10px;
    }
    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 10px;
    }
    .badge{
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-weight:900;
      background:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge.ok{
      border-color:#cfe2ff;
      color:#0b69ff;
      background:#f1f6ff;
    }
    .badge.soldout{
      border-color:#fecaca;
      color:#b91c1c;
      background:#fff5f5;
    }
    .badge.preorder{
      border-color:#fde68a;
      color:#92400e;
      background:#fffbeb;
    }

    /* âœ… åƒ¹æ ¼è¦–è¦º */
    .priceRow{
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
      margin:10px 0 8px;
    }
    .priceNow{
      font-weight:1000;
      font-size:20px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #cfe2ff;
      background:#f1f6ff;
      color:#0b69ff;
    }
    .priceOld{
      font-weight:900;
      font-size:14px;
      color:#9ca3af;
      text-decoration:line-through;
    }
    .priceSpecial{
      font-weight:1000;
      font-size:20px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #fecaca;
      background:#fff5f5;
      color:var(--danger);
      display:inline-flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }

    .meta{
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
      margin-top:8px;
      min-height:0;
    }
    .meta .line{ margin-top:4px; }

    .btn{
      margin-top:12px;
      display:inline-block;
      padding:10px 12px;
      border-radius:12px;
      background:var(--accent);
      color:#fff;
      font-weight:1000;
    }
    .btn.gray{
      background:#d1d5db;
      color:#111;
      cursor:not-allowed;
    }
    .foot{
      margin-top:14px;
      color:var(--muted);
      font-size:14px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <a href="/index.html">â† å›é¦–é </a>
      <a href="/cart.html">å‰å¾€è³¼ç‰©è»Š â†’</a>
    </div>

    <div class="banner" id="banner" style="display:none;">
      <h3 id="bannerTitle">å…¬å‘Š</h3>
      <div class="content" id="bannerContent"></div>
    </div>

    <div class="controls">
      <input id="q" class="search" placeholder="æœå°‹ï¼šåç¨± / ç·¨è™Ÿ / é—œéµå­—â€¦" />
      <div class="chips" id="chips"></div>
    </div>

    <div class="grid" id="grid"></div>
    <div class="foot" id="count"></div>
  </div>

<script>
/* ====== è¨­å®š ====== */
const SHEET_ID="1CFUndaTaa_idLh82JxHp6AXCWPTAUFM8AzGW9NIryIA";
const SHEET_PRODUCTS="Products";
const SHEET_CATEGORIES="Categories";
const SHEET_PUBLIC="Public";
/* ================= */

function gvizUrl(name){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(name)}&tqx=out:json`;
}
async function fetchSheet(name){
  const r = await fetch(gvizUrl(name), { cache:"no-store" });
  const t = await r.text();
  const j = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}")+1));
  const cols = j.table.cols.map(c=>c.label);
  return j.table.rows.map(row=>{
    const o = {};
    row.c.forEach((cell,i)=> o[cols[i]] = cell ? cell.v : "");
    return o;
  });
}
function escapeHtml(s){
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;");
}
function isEnabled(v){
  return v === true || String(v).toUpperCase().trim() === "TRUE";
}
function normStatus(v){
  return String(v || "").trim() || "in_stock";
}
function statusLabel(s){
  if(s==="sold_out") return "å”®å®Œ";
  if(s==="preorder") return "é è³¼";
  return "å¯è³¼è²·";
}
function statusClass(s){
  if(s==="sold_out") return "soldout";
  if(s==="preorder") return "preorder";
  return "ok";
}
function money(n){
  return `NT$ ${Number(n||0)}`;
}
function normalizeText(s){
  return String(s || "").toLowerCase();
}
function parseOptionsPreview(str){
  if(!str) return "";
  const groups = String(str).split(";").map(x=>x.trim()).filter(Boolean);
  const lines = [];
  for(const g of groups){
    const [nRaw, restRaw] = g.split(":");
    const name = (nRaw||"").trim();
    const rest = (restRaw||"").trim();
    if(!name || !rest) continue;

    const items = rest.split("|").map(x=>x.trim()).filter(Boolean).map(item=>{
      const [valRaw, deltaRaw] = item.split("=");
      const val = (valRaw||"").trim();
      const delta = Number((deltaRaw||"0").trim() || 0);
      if(!val) return null;
      return delta ? `${val}ï¼ˆ+${delta}ï¼‰` : val;
    }).filter(Boolean);

    if(items.length){
      lines.push(`${name}ï¼š${items.join("ã€")}`);
    }
  }
  return lines.join("\n");
}

let PRODUCTS=[];
let CATS=[];
let ACTIVE_CAT="å…¨éƒ¨";

function renderChips(){
  const chips = document.getElementById("chips");
  const names = ["å…¨éƒ¨", ...CATS.map(c=>c.name).filter(Boolean)];
  chips.innerHTML = "";
  for(const n of names){
    const el = document.createElement("div");
    el.className = "chip" + (n===ACTIVE_CAT ? " active" : "");
    el.textContent = n;
    el.addEventListener("click", ()=>{
      ACTIVE_CAT = n;
      renderChips();
      renderGrid();
    });
    chips.appendChild(el);
  }
}

function matchCat(p){
  if(ACTIVE_CAT==="å…¨éƒ¨") return true;
  return String(p.category_path || "") === ACTIVE_CAT;
}

function matchQuery(p, q){
  if(!q) return true;
  const hay = [p.name, p.sku, p.search_keyword, p.category_path, p.note]
    .map(normalizeText).join(" ");
  return hay.includes(q);
}

function computeDisplayPrice(p){
  const baseOriginal = Number(p.price || 0);
  const baseSpecial = Number(p.price_override || 0);
  const hasSpecial = !!p.price_override && !Number.isNaN(baseSpecial) && baseSpecial > 0;
  return { baseOriginal, baseSpecial, hasSpecial, base: hasSpecial ? baseSpecial : baseOriginal };
}

function renderGrid(){
  const grid = document.getElementById("grid");
  const q = normalizeText(document.getElementById("q").value);

  const filtered = PRODUCTS
    .filter(p => isEnabled(p.enabled))
    .filter(p => normStatus(p.status) !== "hidden")
    .filter(p => matchCat(p))
    .filter(p => matchQuery(p, q))
    .sort((a,b)=> Number(a.sort||0) - Number(b.sort||0));

  grid.innerHTML = "";

  for(const p of filtered){
    const st = normStatus(p.status);
    const sold = st==="sold_out";
    const { baseOriginal, baseSpecial, hasSpecial, base } = computeDisplayPrice(p);

    const optPreview = parseOptionsPreview(p.options || "");
    const specLine = p.spec ? `è¦æ ¼ï¼š${escapeHtml(p.spec)}` : "";
    const optLines = optPreview ? optPreview.split("\n").map(x=>escapeHtml(x)).join("<br>") : "";

    const priceHtml = hasSpecial
      ? `
        <div class="priceRow">
          <span class="priceOld">${money(baseOriginal)}</span>
          <span class="priceSpecial">ğŸ”¥ ç‰¹åƒ¹ ${money(baseSpecial)}</span>
        </div>
      `
      : `
        <div class="priceRow">
          <span class="priceNow">${money(base)}</span>
        </div>
      `;

    const btn = sold
      ? `<span class="btn gray">å·²å”®å®Œ</span>`
      : `<a class="btn" href="/product.html?sku=${encodeURIComponent(p.sku)}">æŸ¥çœ‹ / é¸é …</a>`;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="thumb">
        ${p.image_url ? `<img src="${escapeHtml(p.image_url)}" alt="${escapeHtml(p.name||"")}">` : "ç„¡åœ–ç‰‡"}
      </div>
      <div class="pad">
        <div class="name">${escapeHtml(p.name||"")}</div>
        <div class="sku">ç·¨è™Ÿï¼š${escapeHtml(p.sku||"")}</div>

        <div class="badges">
          <span class="badge ${statusClass(st)}">${statusLabel(st)}</span>
        </div>

        ${priceHtml}

        <div class="meta">
          ${specLine ? `<div class="line">${specLine}</div>` : ""}
          ${optLines ? `<div class="line">${optLines}</div>` : ""}
        </div>

        ${btn}
      </div>
    `;
    grid.appendChild(card);
  }

  document.getElementById("count").textContent = `é¡¯ç¤º ${filtered.length} ç­†`;
}

async function renderBanner(){
  const rows = await fetchSheet(SHEET_PUBLIC);
  const active = rows
    .filter(r => isEnabled(r.enabled))
    .sort((a,b)=> Number(a.sort||0) - Number(b.sort||0));

  /* âœ… key å…è¨±å‰å¾Œç©ºç™½ï¼Œé¿å…ä½  sheet å¤šæ‰“ä¸€æ ¼ç©ºç™½å°±æ•´å€‹æ¶ˆå¤± */
  const bannerRow = active.find(r => String(r.key||"").trim() === "products_banner");
  if(!bannerRow) return;

  document.getElementById("banner").style.display = "block";
  document.getElementById("bannerTitle").textContent = bannerRow.title || "å…¬å‘Š";
  document.getElementById("bannerContent").textContent = bannerRow.content || "";
}

(async function init(){
  const [products, cats] = await Promise.all([
    fetchSheet(SHEET_PRODUCTS),
    fetchSheet(SHEET_CATEGORIES).catch(()=>[])
  ]);

  PRODUCTS = products || [];

  if((cats||[]).some(x => x.name)){
    CATS = (cats||[])
      .filter(r => isEnabled(r.enabled))
      .sort((a,b)=> Number(a.sort||0) - Number(b.sort||0))
      .map(r => ({ name: r.name }));
  }else{
    const uniq = Array.from(new Set(PRODUCTS.map(p=>String(p.category_path||"").trim()).filter(Boolean)));
    CATS = uniq.map(name=>({name}));
  }

  renderChips();
  renderGrid();
  renderBanner();

  document.getElementById("q").addEventListener("input", renderGrid);
})();
</script>
</body>
</html>

