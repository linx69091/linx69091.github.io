<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>商品詳情</title>
  <style>
    :root{--maxw:1100px;--muted:#6b7280;--accent:#0b69ff;--card:#ffffff;--bg:#fff}
    body{font-family:"Helvetica Neue", Arial, "Noto Sans TC", sans-serif;margin:0;color:#111;background:var(--bg)}
    a{color:inherit}
    .wrap{max-width:var(--maxw);margin:22px auto;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start}
    .card{border:1px solid #eef2f7;border-radius:14px;padding:14px;background:var(--card)}
    .thumb{height:360px;border-radius:12px;background:#f3f6fb;display:flex;align-items:center;justify-content:center;color:var(--muted);overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    h1{margin:10px 0 6px;font-size:28px;letter-spacing:-0.02em}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;color:var(--muted);background:#fff}
    .badge.soldout{border-color:#fecaca;color:#b91c1c;background:#fff5f5}
    .badge.preorder{border-color:#fde68a;color:#92400e;background:#fffbeb}
    .line{height:1px;background:#eef2f7;margin:12px 0}
    label{display:block;font-weight:800;margin:10px 0 6px}
    select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;outline:none;background:#fff}
    select:focus,input:focus{border-color:#bcd4ff;box-shadow:0 0 0 3px rgba(11,105,255,0.10)}
    .price{font-size:20px;font-weight:900}
    .btn{display:inline-block;width:100%;padding:12px 12px;border-radius:12px;text-decoration:none;background:var(--accent);color:#fff;font-weight:900;border:0;cursor:pointer}
    .btn.secondary{background:#111827}
    .btn.disabled{background:#d1d5db;color:#111;cursor:not-allowed}
    .note{color:var(--muted);white-space:pre-wrap}
    .specText{font-weight:800}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} .thumb{height:300px} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <a href="/products.html">← 回商品列表</a>
      <span class="muted"> / 商品詳情</span>
    </div>
    <div class="muted"><a href="/cart.html">前往購物車 →</a></div>
  </div>

  <div id="loading" class="card">讀取中…</div>

  <div id="content" style="display:none">
    <div class="grid">
      <section class="card">
        <div class="thumb" id="thumb">無圖片</div>
        <h1 id="name"></h1>

        <div class="row">
          <span class="badge" id="skuBadge"></span>
          <span class="badge" id="catBadge"></span>
          <span class="badge" id="statusBadge"></span>
        </div>

        <div class="line"></div>

        <div class="muted">規格</div>
        <div class="specText" id="specText">—</div>

        <div class="line"></div>

        <div class="muted">備註</div>
        <div class="note" id="note">—</div>
      </section>

      <aside class="card">
        <div class="row" style="justify-content:space-between">
          <div class="muted">價格</div>
          <div class="price" id="priceText">NT$ 0</div>
        </div>
        <div class="muted" id="priceDetail" style="margin-top:4px"></div>

        <div class="line"></div>

        <div id="optionsArea"></div>

        <label for="qty">數量</label>
        <input id="qty" type="number" min="1" value="1" />

        <div class="line"></div>

        <button id="addBtn" class="btn">加入購物車</button>
        <div style="height:10px"></div>
        <button id="buyBtn" class="btn secondary">加入後前往購物車</button>

        <div style="height:12px"></div>
        <div class="muted" style="font-size:13px">
          spec 是文字規格；options 才是可選項並計入加價。
        </div>
      </aside>
    </div>
  </div>
</div>

<script>
/* ====== 你的設定 ====== */
const SHEET_ID = "1CFUndaTaa_idLh82JxHp6AXCWPTAUFM8AzGW9NIryIA";
const SHEET_PRODUCTS = "Products";
/* ====================== */

const gvizUrl = (sheetName) =>
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;

async function fetchSheet(sheetName){
  const res = await fetch(gvizUrl(sheetName), { cache: "no-store" });
  const text = await res.text();
  const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
  const cols = json.table.cols.map(c => c.label);
  const rows = json.table.rows.map(r => {
    const obj = {};
    r.c.forEach((cell,i)=> obj[cols[i]] = cell ? cell.v : "");
    return obj;
  });
  return rows;
}

function qs(name){ return new URLSearchParams(location.search).get(name) || ""; }
function normBool(v){ return String(v).toUpperCase() === "TRUE"; }
function normStatus(v){ const s = String(v||"").trim(); return s || "in_stock"; }
function escapeHtml(s){
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function parseOptions(optionsStr){
  // options: "顏色:黑=0|棕=0;版本:標準=0|加大=150"
  if(!optionsStr) return [];
  return String(optionsStr).split(";").map(g=>{
    const [name, rest] = g.split(":");
    const values = (rest||"").split("|").map(x=>{
      const [value, delta] = x.split("=");
      return { value: (value||"").trim(), delta: Number(delta||0) };
    }).filter(v=>v.value);
    return { name: (name||"").trim(), values };
  }).filter(g=>g.name && g.values.length);
}

function getCart(){ return JSON.parse(localStorage.getItem("cart") || "[]"); }
function setCart(cart){ localStorage.setItem("cart", JSON.stringify(cart)); }

let PRODUCT = null;
let OPTIONS_DEF = [];
let SELECTED = {}; // name -> {value, delta}

function calcUnitPrice(){
  const base = Number(p.price_override || p.price || 0);
  let delta = 0;
  for(const k of Object.keys(SELECTED)){
    delta += Number(SELECTED[k].delta || 0);
  }
  return { base, delta, unit: base + delta };
}

function renderPrice(){
  const { base, delta, unit } = calcUnitPrice();
  const qty = Math.max(1, Number(document.getElementById("qty").value || 1));
  const total = unit * qty;

  document.getElementById("priceText").textContent = `NT$ ${total}`;
  const detail = [];
  detail.push(`基礎價 ${base}`);
  if(delta) detail.push(`選項加價 ${delta}`);
  detail.push(`單價 ${unit} × ${qty}`);
  document.getElementById("priceDetail").textContent = detail.join("  ·  ");
}

function renderOptions(){
  const area = document.getElementById("optionsArea");
  area.innerHTML = "";

  if(!OPTIONS_DEF.length){
    area.innerHTML = `<div class="muted">可選項：無</div>`;
    return;
  }

  for(const group of OPTIONS_DEF){
    const id = `opt_${group.name}`;
    const label = document.createElement("label");
    label.setAttribute("for", id);
    label.textContent = group.name;
    area.appendChild(label);

    const sel = document.createElement("select");
    sel.id = id;

    for(const opt of group.values){
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.delta ? `${opt.value} (+${opt.delta})` : opt.value;
      sel.appendChild(o);
    }

    const first = group.values[0];
    SELECTED[group.name] = { value: first.value, delta: first.delta };

    sel.addEventListener("change", ()=>{
      const picked = group.values.find(v=>v.value===sel.value);
      SELECTED[group.name] = { value: picked.value, delta: picked.delta };
      renderPrice();
    });

    area.appendChild(sel);
  }
}

function setStatusUI(status){
  const badge = document.getElementById("statusBadge");
  const addBtn = document.getElementById("addBtn");
  const buyBtn = document.getElementById("buyBtn");

  if(status === "sold_out"){
    badge.textContent = "售完";
    badge.className = "badge soldout";
    addBtn.className = "btn disabled";
    buyBtn.className = "btn secondary disabled";
    addBtn.disabled = true;
    buyBtn.disabled = true;
  }else if(status === "preorder"){
    badge.textContent = "預購";
    badge.className = "badge preorder";
    addBtn.className = "btn";
    buyBtn.className = "btn secondary";
    addBtn.disabled = false;
    buyBtn.disabled = false;
  }else{
    badge.textContent = "可購買";
    badge.className = "badge";
    addBtn.className = "btn";
    buyBtn.className = "btn secondary";
    addBtn.disabled = false;
    buyBtn.disabled = false;
  }
}

function addCurrentToCart(goCart){
  const status = normStatus(PRODUCT.status);
  if(status === "sold_out") return;

  const qty = Math.max(1, Number(document.getElementById("qty").value || 1));
  const { unit } = calcUnitPrice();

  const cart = getCart();
  const optKey = Object.keys(SELECTED).sort().map(k=>`${k}=${SELECTED[k].value}`).join("|");
  const lineId = `${PRODUCT.sku}__${optKey}`;

  const existing = cart.find(i => i.line_id === lineId);
  if(existing){
    existing.qty += qty;
  }else{
    cart.push({
      line_id: lineId,
      sku: PRODUCT.sku,
      name: PRODUCT.name,
      category_path: PRODUCT.category_path || "",
      spec_text: PRODUCT.spec || "",
      options_selected: SELECTED,
      base_price: Number(PRODUCT.price || 0),
      unit_price: Number(unit || 0),
      qty,
      image_url: PRODUCT.image_url || ""
    });
  }

  setCart(cart);
  if(goCart) location.href = "/cart.html";
  else alert("已加入購物車 ✅");
}

async function init(){
  const sku = qs("sku").trim();
  if(!sku){
    document.getElementById("loading").textContent = "缺少 sku。請從商品列表點進來。";
    return;
  }

  const products = await fetchSheet(SHEET_PRODUCTS);
  const p = products.find(x => String(x.sku).trim() === sku);

  // ✅ hidden 也當作不可見
  if(!p || !normBool(p.enabled) || normStatus(p.status)==="hidden"){
    document.getElementById("loading").textContent = `找不到商品：${sku}（可能未上架）`;
    return;
  }

  PRODUCT = p;
  document.title = `${PRODUCT.name} — 商品詳情`;

  const imgHtml = PRODUCT.image_url
    ? `<img src="${PRODUCT.image_url}" alt="${escapeHtml(PRODUCT.name)}">`
    : "";
  document.getElementById("thumb").innerHTML = imgHtml || "無圖片";
  document.getElementById("name").textContent = PRODUCT.name || "";
  document.getElementById("skuBadge").textContent = `編號：${PRODUCT.sku || ""}`;
  document.getElementById("catBadge").textContent = `分類：${PRODUCT.category_path || "—"}`;
  document.getElementById("note").textContent = PRODUCT.note ? String(PRODUCT.note) : "—";
  document.getElementById("specText").textContent = PRODUCT.spec ? String(PRODUCT.spec) : "—";

  setStatusUI(normStatus(PRODUCT.status));

  OPTIONS_DEF = parseOptions(PRODUCT.options || "");
  renderOptions();

  document.getElementById("qty").addEventListener("input", renderPrice);
  renderPrice();

  document.getElementById("addBtn").addEventListener("click", ()=> addCurrentToCart(false));
  document.getElementById("buyBtn").addEventListener("click", ()=> addCurrentToCart(true));

  document.getElementById("loading").style.display = "none";
  document.getElementById("content").style.display = "block";
}

init();
</script>
</body>
</html>
