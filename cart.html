<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è³¼ç‰©è»Š</title>

<style>
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --text:#111;
  --muted:#6b7280;
  --line:#e5e7eb;
  --blue:#1a73e8;
  --red:#d93025;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  color:var(--text);
}
.wrap{
  max-width:1000px;
  margin:40px auto;
  padding:0 18px;
}
a{text-decoration:none;color:var(--blue);font-weight:700}
h1{margin:16px 0 24px;font-size:32px}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:18px;
  margin-bottom:16px;
}

.item{
  display:flex;
  gap:16px;
  align-items:flex-start;
  border-bottom:1px solid #f0f2f5;
  padding:14px 0;
}
.item:last-child{border:none}

.thumb{
  width:120px;
  height:80px;
  background:#f3f4f6;
  border-radius:10px;
  overflow:hidden;
  flex-shrink:0;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.info{flex:1}
.name{font-weight:900;font-size:18px;margin-bottom:6px}
.small{font-size:14px;color:var(--muted);margin:3px 0}
.price{font-weight:900;margin-top:6px}

.strike{text-decoration:line-through;color:#9ca3af;margin-right:8px;font-weight:900}
.special{color:var(--red);font-weight:900}

.qty{
  width:80px;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid #dbe2ea;
  font-size:14px;
}

.remove{
  color:#b91c1c;
  font-size:13px;
  cursor:pointer;
  margin-top:8px;
}

.totalBox{
  text-align:right;
  margin-top:20px;
}
.totalBig{
  font-size:24px;
  font-weight:900;
}

.btn{
  margin-top:14px;
  background:var(--blue);
  color:#fff;
  border:none;
  border-radius:12px;
  padding:10px 16px;
  font-weight:900;
  cursor:pointer;
}
.btn:disabled{
  background:#cbd5e1;
  cursor:not-allowed;
}

.empty{
  text-align:center;
  color:var(--muted);
  padding:40px 0;
}

.note{
  margin-top:18px;
  color:var(--muted);
  font-size:14px;
  line-height:1.6;
}

/* checkout form */
.formGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
@media (max-width:780px){
  .formGrid{grid-template-columns:1fr}
}
.field{margin:10px 0}
.field label{
  display:block;
  font-weight:900;
  margin:0 0 6px;
}
input, textarea, select{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #dbe2ea;
  outline:none;
  font-size:15px;
  background:#fff;
}
textarea{min-height:110px;resize:vertical}
input:focus, textarea:focus, select:focus{
  border-color:#bcd4ff;
  box-shadow:0 0 0 3px rgba(26,115,232,0.12);
}
.hr{
  height:1px;
  background:#eef2f7;
  border:none;
  margin:16px 0;
}
.success{
  background:#ecfdf5;
  border:1px solid #bbf7d0;
  color:#065f46;
  padding:12px;
  border-radius:12px;
  font-weight:800;
  line-height:1.6;
}
.error{
  background:#fff1f2;
  border:1px solid #fecdd3;
  color:#9f1239;
  padding:12px;
  border-radius:12px;
  font-weight:800;
  line-height:1.6;
}
</style>
</head>

<body>
<div class="wrap">
  <a href="./products.html">â† å›å•†å“åˆ—è¡¨</a>
  <h1>è³¼ç‰©è»Š</h1>

  <div id="cartArea"></div>

  <div class="note">
    æç¤ºï¼šè³¼ç‰©è»Šå­˜åœ¨æ–¼ä½ çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚<br>
    çµå¸³é€å‡ºå¾Œæœƒç›´æ¥å¯«å…¥ä½ çš„ Google Sheetï¼ˆOrders åˆ†é ï¼‰ã€‚
  </div>
</div>

<script>
/* ===========================
   è¨­å®šï¼šSheet å¯«å…¥ API
=========================== */
const ORDERS_API = "https://script.google.com/macros/s/AKfycbxG_ewTCE65Rp1KAE1h-D7f5_LIwVmGdjRQmCLIts6D0sVLCZQAB6QwgKUdiaMrLKvJcA/exec";

// âš ï¸ é€™ä¸²è¦è·Ÿ Apps Script è£¡ CONFIG.API_TOKEN ä¸€æ¨¡ä¸€æ¨£
const API_TOKEN  = "dong-orders-keep-secret-2026-02-19-9f8a7c6b5d";

/* ===========================
   è³¼ç‰©è»Š localStorage
=========================== */
const CART_KEY="CART_V1";

function readCart(){
  try{ return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
  catch(e){ return []; }
}
function writeCart(items){
  localStorage.setItem(CART_KEY, JSON.stringify(items||[]));
}
function clearCart(){
  localStorage.removeItem(CART_KEY);
}
function money(n){
  return "NT$ " + Number(n||0);
}

/* ===========================
   è¨‚å–®æ–‡å­—çµ„è£
=========================== */
function buildOrderText(cart){
  // äººé¡å¯è®€ï¼Œè½åˆ° Sheet ä¸€æ ¼æ–‡å­—
  return cart.map((it,i)=> {
    const lines = [];
    lines.push(`${i+1}. ${it.name}ï¼ˆ${it.sku}ï¼‰`);
    if(it.options_text) lines.push(`é¸é …ï¼š${it.options_text}`);
    if(it.spec) lines.push(`è¦æ ¼ï¼š${it.spec}`);
    lines.push(`å–®åƒ¹ï¼šNT$ ${Number(it.unit_price||0)} Ã— ${Number(it.qty||1)} = NT$ ${Number(it.total||0)}`);
    return lines.join("\n");
  }).join("\n\n");
}

function calcTotal(cart){
  return cart.reduce((s,it)=> s + Number(it.total||0), 0);
}

/* ===========================
   UI Render
=========================== */
function render(){
  const area = document.getElementById("cartArea");
  const cart = readCart();
  area.innerHTML="";

  if(!cart.length){
    area.innerHTML = `
      <div class="card empty">
        è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„ã€‚å¯ä»¥åˆ°å•†å“é åŠ å…¥å•†å“æ¸¬è©¦ã€‚
      </div>
    `;
    return;
  }

  let totalAll = calcTotal(cart);

  // cart list card
  const cartCard = document.createElement("div");
  cartCard.className="card";

  cart.forEach((item,index)=>{
    const div = document.createElement("div");
    div.className="item";

    const priceBlock = item.price_special
      ? `<span class="strike">${money(item.price_original)}</span>
         <span class="special">ğŸ”¥ ç‰¹åƒ¹ ${money(item.price_special)}</span>`
      : `${money(item.price_original)}`;

    div.innerHTML=`
      <div class="thumb">
        ${item.image_url ? `<img src="${item.image_url}" alt="">` : ""}
      </div>
      <div class="info">
        <div class="name">${item.name}</div>
        <div class="small">ç·¨è™Ÿï¼š${item.sku}</div>
        ${item.options_text ? `<div class="small">${item.options_text}</div>`:""}
        <div class="price">${priceBlock}</div>
        <div class="small">å–®åƒ¹ ${money(item.unit_price)}</div>

        <div style="margin-top:8px;">
          æ•¸é‡ï¼š
          <input type="number" class="qty" min="1" value="${item.qty}" data-index="${index}">
        </div>

        <div class="remove" data-remove="${index}">ç§»é™¤å•†å“</div>
      </div>
    `;
    cartCard.appendChild(div);
  });

  const totalBox=document.createElement("div");
  totalBox.className="totalBox";
  totalBox.innerHTML=`
    <div class="totalBig">ç¸½é‡‘é¡ï¼š${money(totalAll)}</div>
  `;
  cartCard.appendChild(totalBox);

  area.appendChild(cartCard);

  // checkout card
  const checkoutCard = document.createElement("div");
  checkoutCard.className="card";
  checkoutCard.innerHTML = `
    <h2 style="margin:0 0 12px;font-size:20px;">çµå¸³è³‡æ–™</h2>

    <div id="msg"></div>

    <div class="formGrid">
      <div class="field">
        <label>å§“å *</label>
        <input id="f_name" placeholder="æ”¶ä»¶äºº / ä»˜æ¬¾äººå§“å" />
      </div>

      <div class="field">
        <label>Email *</label>
        <input id="f_email" placeholder="ç”¨æ–¼è¯ç¹«èˆ‡ç¢ºèª" />
      </div>

      <div class="field">
        <label>é›»è©±ï¼ˆå¯é¸ï¼‰</label>
        <input id="f_phone" placeholder="ä¾‹å¦‚ 09xx-xxx-xxx" />
      </div>

      <div class="field">
        <label>å–è²¨æ–¹å¼ï¼ˆå¯é¸ï¼‰</label>
        <select id="f_ship">
          <option value="">ï¼ˆä¸å¡«ï¼‰</option>
          <option value="å®…é…">å®…é…</option>
          <option value="7-11">7-11</option>
          <option value="å…¨å®¶">å…¨å®¶</option>
          <option value="é¢äº¤">é¢äº¤</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label>åœ°å€ / é–€å¸‚è³‡è¨Šï¼ˆå¯é¸ï¼‰</label>
      <input id="f_addr" placeholder="å®…é…åœ°å€ æˆ– è¶…å•†åº—è™Ÿ / é–€å¸‚åç¨±" />
    </div>

    <div class="field">
      <label>å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
      <textarea id="f_note" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›æŸå¤©å‰å¯„å‡ºã€é¡è‰²æƒ³å†ç¢ºèªã€æˆ–å…¶ä»–æé†’"></textarea>
    </div>

    <hr class="hr"/>

    <div class="field">
      <label>å³å°‡é€å‡ºçš„è¨‚å–®å…§å®¹ï¼ˆé è¦½ï¼‰</label>
      <textarea id="preview" readonly></textarea>
      <div class="small" style="margin-top:6px;">
        ç¸½é‡‘é¡ï¼š<b id="previewTotal"></b>
      </div>
    </div>

    <button class="btn" id="btnSubmit">é€å‡ºè¨‚å–®ï¼ˆå¯«å…¥ Google Sheetï¼‰</button>
    <div class="note">
      é€å‡ºå¾Œæœƒç”¢ç”Ÿè¨‚å–®ç·¨è™Ÿä¸¦æ¸…ç©ºè³¼ç‰©è»Šã€‚<br>
      è‹¥ä½ è¦åŠ ã€Œä»˜æ¬¾æ–¹å¼ã€æˆ–ã€Œè‡ªå‹•å›ä¿¡ã€ï¼Œä¸‹ä¸€æ­¥ä¹Ÿèƒ½åšã€‚
    </div>
  `;
  area.appendChild(checkoutCard);

  // bind quantity
  document.querySelectorAll(".qty").forEach(input=>{
    input.addEventListener("input",()=>{
      const idx = Number(input.dataset.index);
      const cart = readCart();
      const it = cart[idx];
      const newQty = Math.max(1, Number(input.value||1));

      it.qty = newQty;
      it.total = newQty * Number(it.unit_price||0);

      writeCart(cart);
      render();
    });
  });

  // bind remove
  document.querySelectorAll("[data-remove]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const idx = Number(btn.dataset.remove);
      const cart = readCart();
      cart.splice(idx,1);
      writeCart(cart);
      render();
    });
  });

  // preview
  const preview = document.getElementById("preview");
  const previewTotal = document.getElementById("previewTotal");
  preview.value = buildOrderText(cart);
  previewTotal.textContent = money(calcTotal(cart));

  // submit
  document.getElementById("btnSubmit").addEventListener("click", async ()=>{
    const name  = (document.getElementById("f_name").value||"").trim();
    const email = (document.getElementById("f_email").value||"").trim();
    const phone = (document.getElementById("f_phone").value||"").trim();
    const ship  = (document.getElementById("f_ship").value||"").trim();
    const addr  = (document.getElementById("f_addr").value||"").trim();
    const note  = (document.getElementById("f_note").value||"").trim();

    const msg = document.getElementById("msg");
    msg.innerHTML = "";

    if(!name || !email){
      msg.innerHTML = `<div class="error">è«‹å¡«å¯«ã€Œå§“åã€èˆ‡ã€ŒEmailã€ã€‚</div>`;
      return;
    }

    if(API_TOKEN === "CHANGE_ME_TO_MATCH_YOUR_SCRIPT_TOKEN"){
      msg.innerHTML = `<div class="error">cart.html å°šæœªè¨­å®š API_TOKENï¼ˆéœ€èˆ‡ Apps Script çš„ API_TOKEN ç›¸åŒï¼‰ã€‚</div>`;
      return;
    }

    const cartNow = readCart();
    if(!cartNow.length){
      msg.innerHTML = `<div class="error">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œç„¡æ³•é€å‡ºã€‚</div>`;
      return;
    }

    const payload = {
      token: API_TOKEN,
      customer_name: name,
      customer_email: email,
      customer_phone: phone,
      shipping_method: ship,
      shipping_address: addr,
      note: note,
      order_text: buildOrderText(cartNow),
      total: calcTotal(cartNow),
      order_json: {
        items: cartNow,
        currency: "TWD"
      }
    };

    const btn = document.getElementById("btnSubmit");
    btn.disabled = true;
    btn.textContent = "é€å‡ºä¸­â€¦";

    try{
      const res = await fetch(ORDERS_API, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      if(!data || !data.ok){
        throw new Error(data?.error || "é€å‡ºå¤±æ•—ï¼ˆæœªçŸ¥éŒ¯èª¤ï¼‰");
      }

      clearCart();
      msg.innerHTML = `<div class="success">âœ… å·²é€å‡ºï¼ä½ çš„è¨‚å–®ç·¨è™Ÿï¼š<b>${data.order_id}</b><br>è³‡æ–™å·²å¯«å…¥ Google Sheetï¼ˆOrdersï¼‰ã€‚</div>`;
      render(); // æœƒè®Šç©ºè³¼ç‰©è»Šç•«é¢

    }catch(err){
      msg.innerHTML = `<div class="error">âŒ é€å‡ºå¤±æ•—ï¼š${String(err.message || err)}<br>è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–æª¢æŸ¥ Apps Script æ¬Šé™ / API_TOKENã€‚</div>`;
      btn.disabled = false;
      btn.textContent = "é€å‡ºè¨‚å–®ï¼ˆå¯«å…¥ Google Sheetï¼‰";
    }
  });
}

render();
</script>

</body>
</html>
